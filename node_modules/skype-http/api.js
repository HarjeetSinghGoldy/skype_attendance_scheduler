"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
}
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = __importDefault(require("events"));
const accept_contact_request_1 = require("./api/accept-contact-request");
const add_member_1 = require("./api/add-member");
const create_conversation_1 = require("./api/create-conversation");
const decline_contact_request_1 = require("./api/decline-contact-request");
const get_contact_1 = require("./api/get-contact");
const get_conversation_1 = require("./api/get-conversation");
const get_conversations_1 = require("./api/get-conversations");
const get_join_url_1 = require("./api/get-join-url");
const send_image_1 = require("./api/send-image");
const send_message_1 = require("./api/send-message");
const set_conversation_topic_1 = require("./api/set-conversation-topic");
const set_status_1 = require("./api/set-status");
const contacts_1 = require("./contacts/contacts");
const context_1 = require("./interfaces/api/context");
const messages_poller_1 = require("./polling/messages-poller");
class Api extends events_1.default.EventEmitter {
    constructor(context, io) {
        super();
        this.context = context;
        this.io = io;
        this.messagesPoller = new messages_poller_1.MessagesPoller(this.io, this.context);
        this.messagesPoller.on("error", (err) => this.emit("error", err));
        // tslint:disable-next-line:no-void-expression
        this.messagesPoller.on("event-message", (ev) => this.handlePollingEvent(ev));
        this.contactsService = new contacts_1.ContactsService(this.io);
    }
    async acceptContactRequest(contactUsername) {
        await accept_contact_request_1.acceptContactRequest(this.io, this.context, contactUsername);
        return this;
    }
    async declineContactRequest(contactUsername) {
        await decline_contact_request_1.declineContactRequest(this.io, this.context, contactUsername);
        return this;
    }
    async getContactInvites() {
        return this.contactsService.getInvites(this.context);
    }
    async getContact(contactId) {
        return get_contact_1.getContact(this.io, this.context, contactId);
    }
    async getContacts() {
        return this.contactsService.getContacts(this.context);
    }
    async getConversation(conversationId) {
        return get_conversation_1.getConversation(this.io, this.context, conversationId);
    }
    async getConversations() {
        return get_conversations_1.getConversations(this.io, this.context);
    }
    async sendMessage(message, conversationId) {
        return send_message_1.sendMessage(this.io, this.context, message, conversationId);
    }
    async setConversationTopic(conversationId, topic) {
        return set_conversation_topic_1.setConversationTopic(this.io, this.context, conversationId, topic);
    }
    async getJoinUrl(conversationId) {
        return get_join_url_1.getJoinUrl(this.io, this.context, conversationId);
    }
    async addMemberToConversation(conversationId, memberId) {
        return add_member_1.addMemberToConversation(this.io, this.context, conversationId, memberId);
    }
    async createConversation(allUsers) {
        return create_conversation_1.createConversation(this.io, this.context, allUsers);
    }
    async sendImage(message, conversationId) {
        return send_image_1.sendImage(this.io, this.context, message, conversationId);
    }
    getState() {
        return context_1.Context.toJson(this.context);
    }
    async setStatus(status) {
        return set_status_1.setStatus(this.io, this.context, status);
    }
    /**
     * Start polling and emitting events
     */
    async listen() {
        this.messagesPoller.run();
        return Promise.resolve(this);
    }
    /**
     * Stop polling and emitting events
     */
    async stopListening() {
        this.messagesPoller.stop();
        return Promise.resolve(this);
    }
    handlePollingEvent(ev) {
        this.emit("event", ev);
        if (ev.resource === null) {
            return;
        }
        // Prevent infinite-loop (echo itself)
        if (ev.resource.from.username === this.context.username) {
            return;
        }
        if (ev.resource.type === "Text") {
            this.emit("Text", ev.resource);
        }
        else if (ev.resource.type === "RichText") {
            this.emit("RichText", ev.resource);
        }
    }
}
exports.Api = Api;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDO0NBQ0Y7QUFsSEQsa0JBa0hDIiwiZmlsZSI6ImFwaS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBldmVudHMgZnJvbSBcImV2ZW50c1wiO1xuaW1wb3J0IHsgYWNjZXB0Q29udGFjdFJlcXVlc3QgfSBmcm9tIFwiLi9hcGkvYWNjZXB0LWNvbnRhY3QtcmVxdWVzdFwiO1xuaW1wb3J0IHsgYWRkTWVtYmVyVG9Db252ZXJzYXRpb24gfSBmcm9tIFwiLi9hcGkvYWRkLW1lbWJlclwiO1xuaW1wb3J0IHsgY3JlYXRlQ29udmVyc2F0aW9uIH0gZnJvbSBcIi4vYXBpL2NyZWF0ZS1jb252ZXJzYXRpb25cIjtcbmltcG9ydCB7IGRlY2xpbmVDb250YWN0UmVxdWVzdCB9IGZyb20gXCIuL2FwaS9kZWNsaW5lLWNvbnRhY3QtcmVxdWVzdFwiO1xuaW1wb3J0IHsgZ2V0Q29udGFjdCB9IGZyb20gXCIuL2FwaS9nZXQtY29udGFjdFwiO1xuaW1wb3J0IHsgZ2V0Q29udmVyc2F0aW9uIH0gZnJvbSBcIi4vYXBpL2dldC1jb252ZXJzYXRpb25cIjtcbmltcG9ydCB7IGdldENvbnZlcnNhdGlvbnMgfSBmcm9tIFwiLi9hcGkvZ2V0LWNvbnZlcnNhdGlvbnNcIjtcbmltcG9ydCB7IGdldEpvaW5VcmwgfSBmcm9tIFwiLi9hcGkvZ2V0LWpvaW4tdXJsXCI7XG5pbXBvcnQgeyBzZW5kSW1hZ2UgfSBmcm9tIFwiLi9hcGkvc2VuZC1pbWFnZVwiO1xuaW1wb3J0IHsgc2VuZE1lc3NhZ2UgfSBmcm9tIFwiLi9hcGkvc2VuZC1tZXNzYWdlXCI7XG5pbXBvcnQgeyBzZXRDb252ZXJzYXRpb25Ub3BpYyB9IGZyb20gXCIuL2FwaS9zZXQtY29udmVyc2F0aW9uLXRvcGljXCI7XG5pbXBvcnQgeyBzZXRTdGF0dXMgfSBmcm9tIFwiLi9hcGkvc2V0LXN0YXR1c1wiO1xuaW1wb3J0IHsgQ29udGFjdHNJbnRlcmZhY2UsIENvbnRhY3RzU2VydmljZSB9IGZyb20gXCIuL2NvbnRhY3RzL2NvbnRhY3RzXCI7XG5pbXBvcnQgKiBhcyBhcGkgZnJvbSBcIi4vaW50ZXJmYWNlcy9hcGkvYXBpXCI7XG5pbXBvcnQgeyBDb250YWN0IGFzIF9Db250YWN0IH0gZnJvbSBcIi4vaW50ZXJmYWNlcy9hcGkvY29udGFjdFwiO1xuaW1wb3J0IHsgQ29udGV4dCBhcyBBcGlDb250ZXh0IH0gZnJvbSBcIi4vaW50ZXJmYWNlcy9hcGkvY29udGV4dFwiO1xuaW1wb3J0IHsgQ29udmVyc2F0aW9uIH0gZnJvbSBcIi4vaW50ZXJmYWNlcy9hcGkvY29udmVyc2F0aW9uXCI7XG5pbXBvcnQgKiBhcyBhcGlFdmVudHMgZnJvbSBcIi4vaW50ZXJmYWNlcy9hcGkvZXZlbnRzXCI7XG5pbXBvcnQgeyBIdHRwSW8gfSBmcm9tIFwiLi9pbnRlcmZhY2VzL2h0dHAtaW9cIjtcbmltcG9ydCB7IEFsbFVzZXJzIH0gZnJvbSBcIi4vaW50ZXJmYWNlcy9uYXRpdmUtYXBpL2NvbnZlcnNhdGlvblwiO1xuaW1wb3J0IHsgTWVzc2FnZXNQb2xsZXIgfSBmcm9tIFwiLi9wb2xsaW5nL21lc3NhZ2VzLXBvbGxlclwiO1xuaW1wb3J0IHsgQ29udGFjdCB9IGZyb20gXCIuL3R5cGVzL2NvbnRhY3RcIjtcbmltcG9ydCB7IEludml0ZSB9IGZyb20gXCIuL3R5cGVzL2ludml0ZVwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUV2ZW50cyBleHRlbmRzIE5vZGVKUy5FdmVudEVtaXR0ZXIge1xuXG59XG5cbmV4cG9ydCBjbGFzcyBBcGkgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIGltcGxlbWVudHMgQXBpRXZlbnRzIHtcbiAgaW86IEh0dHBJbztcbiAgY29udGV4dDogQXBpQ29udGV4dDtcbiAgbWVzc2FnZXNQb2xsZXI6IE1lc3NhZ2VzUG9sbGVyO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY29udGFjdHNTZXJ2aWNlOiBDb250YWN0c0ludGVyZmFjZTtcblxuICBjb25zdHJ1Y3Rvcihjb250ZXh0OiBBcGlDb250ZXh0LCBpbzogSHR0cElvKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMuaW8gPSBpbztcbiAgICB0aGlzLm1lc3NhZ2VzUG9sbGVyID0gbmV3IE1lc3NhZ2VzUG9sbGVyKHRoaXMuaW8sIHRoaXMuY29udGV4dCk7XG4gICAgdGhpcy5tZXNzYWdlc1BvbGxlci5vbihcImVycm9yXCIsIChlcnI6IEVycm9yKSA9PiB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnIpKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdm9pZC1leHByZXNzaW9uXG4gICAgdGhpcy5tZXNzYWdlc1BvbGxlci5vbihcImV2ZW50LW1lc3NhZ2VcIiwgKGV2OiBhcGlFdmVudHMuRXZlbnRNZXNzYWdlKSA9PiB0aGlzLmhhbmRsZVBvbGxpbmdFdmVudChldikpO1xuICAgIHRoaXMuY29udGFjdHNTZXJ2aWNlID0gbmV3IENvbnRhY3RzU2VydmljZSh0aGlzLmlvKTtcbiAgfVxuXG4gIGFzeW5jIGFjY2VwdENvbnRhY3RSZXF1ZXN0KGNvbnRhY3RVc2VybmFtZTogc3RyaW5nKTogUHJvbWlzZTx0aGlzPiB7XG4gICAgYXdhaXQgYWNjZXB0Q29udGFjdFJlcXVlc3QodGhpcy5pbywgdGhpcy5jb250ZXh0LCBjb250YWN0VXNlcm5hbWUpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYXN5bmMgZGVjbGluZUNvbnRhY3RSZXF1ZXN0KGNvbnRhY3RVc2VybmFtZTogc3RyaW5nKTogUHJvbWlzZTx0aGlzPiB7XG4gICAgYXdhaXQgZGVjbGluZUNvbnRhY3RSZXF1ZXN0KHRoaXMuaW8sIHRoaXMuY29udGV4dCwgY29udGFjdFVzZXJuYW1lKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFzeW5jIGdldENvbnRhY3RJbnZpdGVzKCk6IFByb21pc2U8SW52aXRlW10+IHtcbiAgICByZXR1cm4gdGhpcy5jb250YWN0c1NlcnZpY2UuZ2V0SW52aXRlcyh0aGlzLmNvbnRleHQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29udGFjdChjb250YWN0SWQ6IHN0cmluZyk6IFByb21pc2U8X0NvbnRhY3Q+IHtcbiAgICByZXR1cm4gZ2V0Q29udGFjdCh0aGlzLmlvLCB0aGlzLmNvbnRleHQsIGNvbnRhY3RJZCk7XG4gIH1cblxuICBhc3luYyBnZXRDb250YWN0cygpOiBQcm9taXNlPENvbnRhY3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRhY3RzU2VydmljZS5nZXRDb250YWN0cyh0aGlzLmNvbnRleHQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29udmVyc2F0aW9uKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcpOiBQcm9taXNlPENvbnZlcnNhdGlvbj4ge1xuICAgIHJldHVybiBnZXRDb252ZXJzYXRpb24odGhpcy5pbywgdGhpcy5jb250ZXh0LCBjb252ZXJzYXRpb25JZCk7XG4gIH1cblxuICBhc3luYyBnZXRDb252ZXJzYXRpb25zKCk6IFByb21pc2U8Q29udmVyc2F0aW9uW10+IHtcbiAgICByZXR1cm4gZ2V0Q29udmVyc2F0aW9ucyh0aGlzLmlvLCB0aGlzLmNvbnRleHQpO1xuICB9XG5cbiAgYXN5bmMgc2VuZE1lc3NhZ2UobWVzc2FnZTogYXBpLk5ld01lc3NhZ2UsIGNvbnZlcnNhdGlvbklkOiBzdHJpbmcpOiBQcm9taXNlPGFwaS5TZW5kTWVzc2FnZVJlc3VsdD4ge1xuICAgIHJldHVybiBzZW5kTWVzc2FnZSh0aGlzLmlvLCB0aGlzLmNvbnRleHQsIG1lc3NhZ2UsIGNvbnZlcnNhdGlvbklkKTtcbiAgfVxuXG4gIGFzeW5jIHNldENvbnZlcnNhdGlvblRvcGljKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIHRvcGljOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gc2V0Q29udmVyc2F0aW9uVG9waWModGhpcy5pbywgdGhpcy5jb250ZXh0LCBjb252ZXJzYXRpb25JZCwgdG9waWMpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Sm9pblVybChjb252ZXJzYXRpb25JZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gZ2V0Sm9pblVybCh0aGlzLmlvLCB0aGlzLmNvbnRleHQsIGNvbnZlcnNhdGlvbklkKTtcbiAgfVxuXG4gIGFzeW5jIGFkZE1lbWJlclRvQ29udmVyc2F0aW9uKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIG1lbWJlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gYWRkTWVtYmVyVG9Db252ZXJzYXRpb24odGhpcy5pbywgdGhpcy5jb250ZXh0LCBjb252ZXJzYXRpb25JZCwgbWVtYmVySWQpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlQ29udmVyc2F0aW9uKGFsbFVzZXJzOiBBbGxVc2Vycyk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIGNyZWF0ZUNvbnZlcnNhdGlvbih0aGlzLmlvLCB0aGlzLmNvbnRleHQsIGFsbFVzZXJzKTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRJbWFnZShtZXNzYWdlOiBhcGkuTmV3SW1hZ2UsIGNvbnZlcnNhdGlvbklkOiBzdHJpbmcpOiBQcm9taXNlPGFwaS5TZW5kTWVzc2FnZVJlc3VsdD4ge1xuICAgIHJldHVybiBzZW5kSW1hZ2UodGhpcy5pbywgdGhpcy5jb250ZXh0LCBtZXNzYWdlLCBjb252ZXJzYXRpb25JZCk7XG4gIH1cblxuICBnZXRTdGF0ZSgpOiBBcGlDb250ZXh0Lkpzb24ge1xuICAgIHJldHVybiBBcGlDb250ZXh0LnRvSnNvbih0aGlzLmNvbnRleHQpO1xuICB9XG5cbiAgYXN5bmMgc2V0U3RhdHVzKHN0YXR1czogYXBpLlN0YXR1cyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBzZXRTdGF0dXModGhpcy5pbywgdGhpcy5jb250ZXh0LCBzdGF0dXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IHBvbGxpbmcgYW5kIGVtaXR0aW5nIGV2ZW50c1xuICAgKi9cbiAgYXN5bmMgbGlzdGVuKCk6IFByb21pc2U8dGhpcz4ge1xuICAgIHRoaXMubWVzc2FnZXNQb2xsZXIucnVuKCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIHBvbGxpbmcgYW5kIGVtaXR0aW5nIGV2ZW50c1xuICAgKi9cbiAgYXN5bmMgc3RvcExpc3RlbmluZygpOiBQcm9taXNlPHRoaXM+IHtcbiAgICB0aGlzLm1lc3NhZ2VzUG9sbGVyLnN0b3AoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGhhbmRsZVBvbGxpbmdFdmVudChldjogYXBpRXZlbnRzLkV2ZW50TWVzc2FnZSk6IHZvaWQge1xuICAgIHRoaXMuZW1pdChcImV2ZW50XCIsIGV2KTtcblxuICAgIGlmIChldi5yZXNvdXJjZSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFByZXZlbnQgaW5maW5pdGUtbG9vcCAoZWNobyBpdHNlbGYpXG4gICAgaWYgKGV2LnJlc291cmNlLmZyb20udXNlcm5hbWUgPT09IHRoaXMuY29udGV4dC51c2VybmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChldi5yZXNvdXJjZS50eXBlID09PSBcIlRleHRcIikge1xuICAgICAgdGhpcy5lbWl0KFwiVGV4dFwiLCBldi5yZXNvdXJjZSk7XG4gICAgfSBlbHNlIGlmIChldi5yZXNvdXJjZS50eXBlID09PSBcIlJpY2hUZXh0XCIpIHtcbiAgICAgIHRoaXMuZW1pdChcIlJpY2hUZXh0XCIsIGV2LnJlc291cmNlKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=
