"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const lazy_properties_1 = require("../_helpers/lazy-properties");
const invalid_integer_1 = require("../errors/invalid-integer");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
exports.name = "integer";
/**
 * Default value for the `min` option.
 * It corresponds to `-(2**53)`.
 */
exports.DEFAULT_MIN = Number.MIN_SAFE_INTEGER - 1;
/**
 * Default value for the `max` option.
 * It corresponds to `2**53 - 1`.
 */
exports.DEFAULT_MAX = Number.MAX_SAFE_INTEGER;
class IntegerType {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.min = undefined;
        this.max = undefined;
        if (options === undefined) {
            this._options = {};
            this._applyOptions();
            return;
        }
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["min", "max"]);
        }
    }
    static fromJSON(options) {
        return new IntegerType(options);
    }
    toJSON() {
        return { name: exports.name, min: this.min, max: this.max };
    }
    readTrustedJson(input) {
        return input;
    }
    readJson(input) {
        let val;
        if (typeof input !== "number") {
            throw invalid_type_1.createInvalidTypeError("number", input);
        }
        val = input;
        const err = this.testError(val);
        if (err !== undefined) {
            throw err;
        }
        return val;
    }
    writeJson(val) {
        return val;
    }
    testError(val) {
        if (typeof val !== "number") {
            return invalid_type_1.createInvalidTypeError("number", val);
        }
        if (Math.round(val) !== val) {
            return invalid_integer_1.createInvalidIntegerError(val);
        }
        if (val < this.min || val > this.max) {
            return new incident_1.Incident("Range", { value: val, min: this.min, max: this.max }, "Integer not in range");
        }
        return undefined;
    }
    test(val) {
        return typeof val === "number" && val >= this.min && val <= this.max && Math.round(val) === val;
    }
    equals(val1, val2) {
        return val1 === val2;
    }
    clone(val) {
        return val;
    }
    diff(oldVal, newVal) {
        return newVal === oldVal ? undefined : newVal - oldVal;
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : oldVal + diff;
    }
    reverseDiff(diff) {
        /* tslint:disable-next-line:strict-boolean-expressions */
        return diff && -diff;
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2;
        }
        else if (diff2 === undefined) {
            return diff1;
        }
        return diff2 === -diff1 ? undefined : diff1 + diff2;
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const min = options.min !== undefined ? options.min : exports.DEFAULT_MIN;
        const max = options.max !== undefined ? options.max : exports.DEFAULT_MAX;
        Object.assign(this, { min, max });
        Object.freeze(this);
    }
}
exports.IntegerType = IntegerType;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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bUhDIiwiZmlsZSI6InR5cGVzL2ludGVnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgbGF6eVByb3BlcnRpZXMgfSBmcm9tIFwiLi4vX2hlbHBlcnMvbGF6eS1wcm9wZXJ0aWVzXCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkSW50ZWdlckVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLWludGVnZXJcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtdHlwZVwiO1xuaW1wb3J0IHsgY3JlYXRlTGF6eU9wdGlvbnNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbGF6eS1vcHRpb25zXCI7XG5pbXBvcnQgeyBMYXp5LCBWZXJzaW9uZWRUeXBlIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcImludGVnZXJcIjtcbmV4cG9ydCBjb25zdCBuYW1lOiBOYW1lID0gXCJpbnRlZ2VyXCI7XG5leHBvcnQgbmFtZXNwYWNlIGpzb24ge1xuICBleHBvcnQgdHlwZSBJbnB1dCA9IG51bWJlcjtcbiAgZXhwb3J0IHR5cGUgT3V0cHV0ID0gbnVtYmVyO1xuXG4gIGV4cG9ydCBpbnRlcmZhY2UgVHlwZSB7XG4gICAgbmFtZTogTmFtZTtcbiAgICBtaW46IG51bWJlcjtcbiAgICBtYXg6IG51bWJlcjtcbiAgfVxufVxuZXhwb3J0IHR5cGUgRGlmZiA9IG51bWJlcjtcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgYGludGVnZXJgIHR5cGUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSW50ZWdlclR5cGVPcHRpb25zIHtcbiAgLyoqXG4gICAqIEluY2x1c2l2ZSBtaW5pbXVtIHZhbHVlLlxuICAgKi9cbiAgbWluPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBJbmNsdXNpdmUgbWF4aW11bSB2YWx1ZS5cbiAgICovXG4gIG1heD86IG51bWJlcjtcbn1cblxuLyoqXG4gKiBEZWZhdWx0IHZhbHVlIGZvciB0aGUgYG1pbmAgb3B0aW9uLlxuICogSXQgY29ycmVzcG9uZHMgdG8gYC0oMioqNTMpYC5cbiAqL1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfTUlOOiBudW1iZXIgPSBOdW1iZXIuTUlOX1NBRkVfSU5URUdFUiAtIDE7XG5cbi8qKlxuICogRGVmYXVsdCB2YWx1ZSBmb3IgdGhlIGBtYXhgIG9wdGlvbi5cbiAqIEl0IGNvcnJlc3BvbmRzIHRvIGAyKio1MyAtIDFgLlxuICovXG5leHBvcnQgY29uc3QgREVGQVVMVF9NQVg6IG51bWJlciA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSO1xuXG5leHBvcnQgY2xhc3MgSW50ZWdlclR5cGUgaW1wbGVtZW50cyBWZXJzaW9uZWRUeXBlPG51bWJlciwganNvbi5JbnB1dCwganNvbi5PdXRwdXQsIERpZmY+IHtcblxuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgbWluOiBudW1iZXI7XG4gIHJlYWRvbmx5IG1heDogbnVtYmVyO1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IExhenk8SW50ZWdlclR5cGVPcHRpb25zPjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zPzogTGF6eTxJbnRlZ2VyVHlwZU9wdGlvbnM+KSB7XG4gICAgLy8gVE9ETzogUmVtb3ZlIG9uY2UgVFMgMi43IGlzIGJldHRlciBzdXBwb3J0ZWQgYnkgZWRpdG9yc1xuICAgIHRoaXMubWluID0gPGFueT4gdW5kZWZpbmVkO1xuICAgIHRoaXMubWF4ID0gPGFueT4gdW5kZWZpbmVkO1xuXG4gICAgaWYgKG9wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fb3B0aW9ucyA9IHt9O1xuICAgICAgdGhpcy5fYXBwbHlPcHRpb25zKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXModGhpcywgdGhpcy5fYXBwbHlPcHRpb25zLCBbXCJtaW5cIiwgXCJtYXhcIl0pO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBmcm9tSlNPTihvcHRpb25zOiBqc29uLlR5cGUpOiBJbnRlZ2VyVHlwZSB7XG4gICAgcmV0dXJuIG5ldyBJbnRlZ2VyVHlwZShvcHRpb25zKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBqc29uLlR5cGUge1xuICAgIHJldHVybiB7bmFtZSwgbWluOiB0aGlzLm1pbiwgbWF4OiB0aGlzLm1heH07XG4gIH1cblxuICByZWFkVHJ1c3RlZEpzb24oaW5wdXQ6IGpzb24uT3V0cHV0KTogbnVtYmVyIHtcbiAgICByZXR1cm4gaW5wdXQ7XG4gIH1cblxuICByZWFkSnNvbihpbnB1dDogYW55KTogbnVtYmVyIHtcbiAgICBsZXQgdmFsOiBudW1iZXI7XG4gICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gXCJudW1iZXJcIikge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIm51bWJlclwiLCBpbnB1dCk7XG4gICAgfVxuICAgIHZhbCA9IGlucHV0O1xuICAgIGNvbnN0IGVycjogRXJyb3IgfCB1bmRlZmluZWQgPSB0aGlzLnRlc3RFcnJvcih2YWwpO1xuICAgIGlmIChlcnIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cblxuICAgIHJldHVybiB2YWw7XG4gIH1cblxuICB3cml0ZUpzb24odmFsOiBudW1iZXIpOiBqc29uLk91dHB1dCB7XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IG51bWJlcik6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudW1iZXJcIiwgdmFsKTtcbiAgICB9XG4gICAgaWYgKE1hdGgucm91bmQodmFsKSAhPT0gdmFsKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZEludGVnZXJFcnJvcih2YWwpO1xuICAgIH1cbiAgICBpZiAodmFsIDwgdGhpcy5taW4gfHwgdmFsID4gdGhpcy5tYXgpIHtcbiAgICAgIHJldHVybiBuZXcgSW5jaWRlbnQoXCJSYW5nZVwiLCB7dmFsdWU6IHZhbCwgbWluOiB0aGlzLm1pbiwgbWF4OiB0aGlzLm1heH0sIFwiSW50ZWdlciBub3QgaW4gcmFuZ2VcIik7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWwgPT09IFwibnVtYmVyXCIgJiYgdmFsID49IHRoaXMubWluICYmIHZhbCA8PSB0aGlzLm1heCAmJiBNYXRoLnJvdW5kKHZhbCkgPT09IHZhbDtcbiAgfVxuXG4gIGVxdWFscyh2YWwxOiBudW1iZXIsIHZhbDI6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2YWwxID09PSB2YWwyO1xuICB9XG5cbiAgY2xvbmUodmFsOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiB2YWw7XG4gIH1cblxuICBkaWZmKG9sZFZhbDogbnVtYmVyLCBuZXdWYWw6IG51bWJlcik6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiBuZXdWYWwgPT09IG9sZFZhbCA/IHVuZGVmaW5lZCA6IG5ld1ZhbCAtIG9sZFZhbDtcbiAgfVxuXG4gIHBhdGNoKG9sZFZhbDogbnVtYmVyLCBkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogbnVtYmVyIHtcbiAgICByZXR1cm4gZGlmZiA9PT0gdW5kZWZpbmVkID8gb2xkVmFsIDogb2xkVmFsICsgZGlmZiBhcyBudW1iZXI7XG4gIH1cblxuICByZXZlcnNlRGlmZihkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC1ib29sZWFuLWV4cHJlc3Npb25zICovXG4gICAgcmV0dXJuIGRpZmYgJiYgLWRpZmY7XG4gIH1cblxuICBzcXVhc2goZGlmZjE6IERpZmYgfCB1bmRlZmluZWQsIGRpZmYyOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKGRpZmYxID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBkaWZmMjtcbiAgICB9IGVsc2UgaWYgKGRpZmYyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBkaWZmMTtcbiAgICB9XG4gICAgcmV0dXJuIGRpZmYyID09PSAtZGlmZjEgPyB1bmRlZmluZWQgOiBkaWZmMSArIGRpZmYyO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlPcHRpb25zKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9vcHRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IodGhpcyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnM6IEludGVnZXJUeXBlT3B0aW9ucyA9IHR5cGVvZiB0aGlzLl9vcHRpb25zID09PSBcImZ1bmN0aW9uXCIgPyB0aGlzLl9vcHRpb25zKCkgOiB0aGlzLl9vcHRpb25zO1xuXG4gICAgY29uc3QgbWluOiBudW1iZXIgPSBvcHRpb25zLm1pbiAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW4gOiBERUZBVUxUX01JTjtcbiAgICBjb25zdCBtYXg6IG51bWJlciA9IG9wdGlvbnMubWF4ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1heCA6IERFRkFVTFRfTUFYO1xuXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7bWluLCBtYXh9KTtcbiAgICBPYmplY3QuZnJlZXplKHRoaXMpO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii4uIn0=
