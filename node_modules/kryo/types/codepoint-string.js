"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const checked_ucs2_decode_1 = require("../_helpers/checked-ucs2-decode");
const lazy_properties_1 = require("../_helpers/lazy-properties");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
const lower_case_1 = require("../errors/lower-case");
const max_codepoints_1 = require("../errors/max-codepoints");
const min_codepoints_1 = require("../errors/min-codepoints");
const missing_dependency_1 = require("../errors/missing-dependency");
const not_trimmed_1 = require("../errors/not-trimmed");
const pattern_not_matched_1 = require("../errors/pattern-not-matched");
let unormNfc = undefined;
try {
    /* tslint:disable-next-line:no-var-requires no-require-imports */
    unormNfc = require("unorm").nfc;
}
catch (err) {
    // Ignore dependency not found error.
}
var Normalization;
(function (Normalization) {
    Normalization[Normalization["None"] = 0] = "None";
    Normalization[Normalization["Nfc"] = 1] = "Nfc";
})(Normalization = exports.Normalization || (exports.Normalization = {}));
exports.name = "codepoint-string";
class CodepointStringType {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.normalization = undefined;
        this.enforceUnicodeRegExp = undefined;
        this.lowerCase = undefined;
        this.trimmed = undefined;
        this.maxCodepoints = undefined;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["normalization", "enforceUnicodeRegExp", "pattern", "lowerCase", "trimmed", "minCodepoints", "maxCodepoints"]);
        }
    }
    static fromJSON(options) {
        const resolvedOptions = {
            normalization: options.normalization === "none" ? Normalization.None : Normalization.Nfc,
            enforceUnicodeRegExp: options.enforceUnicodeRegExp,
            lowerCase: options.lowerCase,
            trimmed: options.trimmed,
            maxCodepoints: options.maxCodepoints,
        };
        if (options.pattern !== undefined) {
            resolvedOptions.pattern = new RegExp(options.pattern[0], options.pattern[1]);
        }
        if (options.minCodepoints !== undefined) {
            resolvedOptions.minCodepoints = options.minCodepoints;
        }
        return new CodepointStringType(resolvedOptions);
    }
    toJSON() {
        const jsonType = {
            name: exports.name,
            normalization: this.normalization === Normalization.None ? "none" : "nfc",
            enforceUnicodeRegExp: this.enforceUnicodeRegExp,
            lowerCase: this.lowerCase,
            trimmed: this.trimmed,
            maxCodepoints: this.maxCodepoints,
        };
        if (this.pattern !== undefined) {
            jsonType.pattern = [this.pattern.source, this.pattern.flags];
        }
        if (this.minCodepoints !== undefined) {
            jsonType.minCodepoints = this.minCodepoints;
        }
        return jsonType;
    }
    readTrustedJson(input) {
        return input;
    }
    readJson(input) {
        const error = this.testError(input);
        if (error !== undefined) {
            throw error;
        }
        return input;
    }
    writeJson(val) {
        return val;
    }
    testError(val) {
        if (!(typeof val === "string")) {
            return invalid_type_1.createInvalidTypeError("string", val);
        }
        switch (this.normalization) {
            case Normalization.Nfc:
                if (unormNfc === undefined) {
                    throw missing_dependency_1.createMissingDependencyError("unorm", "Required to normalize unicode strings to NFC.");
                }
                if (val !== unormNfc(val)) {
                    return incident_1.Incident("UnicodeNormalization", "Not NFC-Normalized");
                }
                break;
            case Normalization.None:
                break;
            default:
                throw new incident_1.Incident(`IncompleteSwitch: Received unexpected variant for this.normalization: ${this.normalization}`);
        }
        if (this.lowerCase && val !== val.toLowerCase()) {
            return lower_case_1.createLowerCaseError(val);
        }
        if (this.trimmed && val !== val.trim()) {
            return not_trimmed_1.createNotTrimmedError(val);
        }
        let codepointCount;
        try {
            codepointCount = checked_ucs2_decode_1.checkedUcs2Decode(val).length;
        }
        catch (err) {
            return err;
        }
        const minCodepoints = this.minCodepoints;
        if (typeof minCodepoints === "number" && codepointCount < minCodepoints) {
            return min_codepoints_1.createMinCodepointsError(val, codepointCount, minCodepoints);
        }
        if (codepointCount > this.maxCodepoints) {
            return max_codepoints_1.createMaxCodepointsError(val, codepointCount, this.maxCodepoints);
        }
        if (this.pattern instanceof RegExp) {
            if (!this.pattern.unicode && this.enforceUnicodeRegExp) {
                throw new incident_1.Incident("NonUnicodeRegExp", "Enforced unicode RegExp, use `enforceUnicodeRegExp = false` or `Ucs2StringType`");
            }
            if (!this.pattern.test(val)) {
                return pattern_not_matched_1.createPatternNotMatchedError(this.pattern, val);
            }
        }
        return undefined;
    }
    test(val) {
        return this.testError(val) === undefined;
    }
    equals(val1, val2) {
        return val1 === val2;
    }
    clone(val) {
        return val;
    }
    diff(oldVal, newVal) {
        return oldVal === newVal ? undefined : [oldVal, newVal];
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : diff[1];
    }
    reverseDiff(diff) {
        return diff === undefined ? undefined : [diff[1], diff[0]];
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2 === undefined ? undefined : [diff2[0], diff2[1]];
        }
        else if (diff2 === undefined) {
            return [diff1[0], diff1[1]];
        }
        return diff1[0] === diff2[1] ? undefined : [diff1[0], diff2[1]];
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const normalization = options.normalization !== undefined ?
            options.normalization :
            Normalization.Nfc;
        const enforceUnicodeRegExp = options.enforceUnicodeRegExp !== undefined ?
            options.enforceUnicodeRegExp :
            true;
        const pattern = options.pattern;
        const lowerCase = options.lowerCase !== undefined ? options.lowerCase : false;
        const trimmed = options.trimmed !== undefined ? options.trimmed : false;
        const minCodepoints = options.minCodepoints;
        const maxCodepoints = options.maxCodepoints;
        Object.assign(this, { normalization, enforceUnicodeRegExp, pattern, lowerCase, trimmed, minCodepoints, maxCodepoints });
        Object.freeze(this);
    }
}
exports.CodepointStringType = CodepointStringType;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LE9BQU8sQ0FBQyxPQUFPLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDakYsTUFBTSxhQUFhLEdBQXVCLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDaEUsTUFBTSxhQUFhLEdBQVcsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUVwRCxNQUFNLENBQUMsTUFBTSxDQUNYLElBQUksRUFDSixFQUFDLGFBQWEsRUFBRSxvQkFBb0IsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFDLENBQ2pHLENBQUM7UUFDRixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQTNNRCxrREEyTUMiLCJmaWxlIjoidHlwZXMvY29kZXBvaW50LXN0cmluZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluY2lkZW50IH0gZnJvbSBcImluY2lkZW50XCI7XG5pbXBvcnQgeyBjaGVja2VkVWNzMkRlY29kZSB9IGZyb20gXCIuLi9faGVscGVycy9jaGVja2VkLXVjczItZGVjb2RlXCI7XG5pbXBvcnQgeyBsYXp5UHJvcGVydGllcyB9IGZyb20gXCIuLi9faGVscGVycy9sYXp5LXByb3BlcnRpZXNcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtdHlwZVwiO1xuaW1wb3J0IHsgY3JlYXRlTGF6eU9wdGlvbnNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbGF6eS1vcHRpb25zXCI7XG5pbXBvcnQgeyBjcmVhdGVMb3dlckNhc2VFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbG93ZXItY2FzZVwiO1xuaW1wb3J0IHsgY3JlYXRlTWF4Q29kZXBvaW50c0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9tYXgtY29kZXBvaW50c1wiO1xuaW1wb3J0IHsgY3JlYXRlTWluQ29kZXBvaW50c0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9taW4tY29kZXBvaW50c1wiO1xuaW1wb3J0IHsgY3JlYXRlTWlzc2luZ0RlcGVuZGVuY3lFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbWlzc2luZy1kZXBlbmRlbmN5XCI7XG5pbXBvcnQgeyBjcmVhdGVOb3RUcmltbWVkRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL25vdC10cmltbWVkXCI7XG5pbXBvcnQgeyBjcmVhdGVQYXR0ZXJuTm90TWF0Y2hlZEVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9wYXR0ZXJuLW5vdC1tYXRjaGVkXCI7XG5pbXBvcnQgeyBMYXp5LCBWZXJzaW9uZWRUeXBlIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmxldCB1bm9ybU5mYzogKChzdHI6IHN0cmluZykgPT4gc3RyaW5nKSB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbnRyeSB7XG4gIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXMgbm8tcmVxdWlyZS1pbXBvcnRzICovXG4gIHVub3JtTmZjID0gcmVxdWlyZShcInVub3JtXCIpLm5mYztcbn0gY2F0Y2ggKGVycikge1xuICAvLyBJZ25vcmUgZGVwZW5kZW5jeSBub3QgZm91bmQgZXJyb3IuXG59XG5cbmV4cG9ydCBlbnVtIE5vcm1hbGl6YXRpb24ge1xuICBOb25lLFxuICBOZmMsXG59XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcImNvZGVwb2ludC1zdHJpbmdcIjtcbmV4cG9ydCBjb25zdCBuYW1lOiBOYW1lID0gXCJjb2RlcG9pbnQtc3RyaW5nXCI7XG5leHBvcnQgbmFtZXNwYWNlIGpzb24ge1xuICBleHBvcnQgdHlwZSBJbnB1dCA9IHN0cmluZztcbiAgZXhwb3J0IHR5cGUgT3V0cHV0ID0gc3RyaW5nO1xuXG4gIGV4cG9ydCBpbnRlcmZhY2UgVHlwZSB7XG4gICAgbmFtZTogTmFtZTtcbiAgICBub3JtYWxpemF0aW9uOiBcIm5vbmVcIiB8IFwibmZjXCI7XG4gICAgZW5mb3JjZVVuaWNvZGVSZWdFeHA6IGJvb2xlYW47XG4gICAgcGF0dGVybj86IFtzdHJpbmcsIHN0cmluZ107XG4gICAgbG93ZXJDYXNlOiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEBzZWUgW1tVY3MyU3RyaW5nT3B0aW9ucy50cmltbWVkXV1cbiAgICAgKi9cbiAgICB0cmltbWVkOiBib29sZWFuO1xuICAgIG1pbkNvZGVwb2ludHM/OiBudW1iZXI7XG4gICAgbWF4Q29kZXBvaW50czogbnVtYmVyO1xuICB9XG59XG5leHBvcnQgdHlwZSBEaWZmID0gW3N0cmluZywgc3RyaW5nXTtcblxuZXhwb3J0IGludGVyZmFjZSBDb2RlcG9pbnRTdHJpbmdPcHRpb25zIHtcbiAgLyoqXG4gICAqIEVuc3VyZSBORkMgbm9ybWFsaXphdGlvbiB3aGVuIHJlYWRpbmcgc3RyaW5ncy5cbiAgICpcbiAgICogUmVmZXJlbmNlczpcbiAgICogLSBodHRwOi8vdW5pY29kZS5vcmcvZmFxL25vcm1hbGl6YXRpb24uaHRtbFxuICAgKiAtIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcnRzL3RyMTUvXG4gICAqL1xuICBub3JtYWxpemF0aW9uPzogTm9ybWFsaXphdGlvbjtcblxuICBlbmZvcmNlVW5pY29kZVJlZ0V4cD86IGJvb2xlYW47XG4gIHBhdHRlcm4/OiBSZWdFeHA7XG4gIGxvd2VyQ2FzZT86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFRoZSBzdHJpbmcgY2Fubm90IHN0YXJ0IG9yIGVuZCB3aXRoIGFueSBvZiB0aGUgZm9sbG93aW5nIHdoaXRlc3BhY2UgYW5kIGxpbmUgdGVybWluYXRvclxuICAgKiBjaGFyYWN0ZXJzOlxuICAgKlxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdDSEFSQUNURVIgVEFCVUxBVElPTicgKFUrMDAwOSlcbiAgICogLSBVbmljb2RlIENoYXJhY3RlciAnTElORSBGRUVEIChMRiknIChVKzAwMEEpXG4gICAqIC0gVW5pY29kZSBDaGFyYWN0ZXIgJ0xJTkUgVEFCVUxBVElPTicgKFUrMDAwQilcbiAgICogLSBVbmljb2RlIENoYXJhY3RlciAnRk9STSBGRUVEIChGRiknIChVKzAwMEMpXG4gICAqIC0gVW5pY29kZSBDaGFyYWN0ZXIgJ0NBUlJJQUdFIFJFVFVSTiAoQ1IpJyAoVSswMDBEKVxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdTUEFDRScgKFUrMDAyMClcbiAgICogLSBVbmljb2RlIENoYXJhY3RlciAnTk8tQlJFQUsgU1BBQ0UnIChVKzAwQTApXG4gICAqIC0gVW5pY29kZSBDaGFyYWN0ZXIgJ0xJTkUgU0VQQVJBVE9SJyAoVSsyMDI4KVxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdQQVJBR1JBUEggU0VQQVJBVE9SJyAoVSsyMDI5KVxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdaRVJPIFdJRFRIIE5PLUJSRUFLIFNQQUNFJyAoVStGRUZGKVxuICAgKiAtIEFueSBvdGhlciBVbmljb2RlIGNoYXJhY3RlciBvZiB0aGUgXCJTZXBhcmF0b3IsIHNwYWNlXCIgKFpzKSBnZW5lcmFsIGNhdGVnb3J5XG4gICAqXG4gICAqIEBzZWUgPGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL1N0cmluZy9UcmltPlxuICAgKiBAc2VlIDxodHRwOi8vd3d3LmZpbGVmb3JtYXQuaW5mby9pbmZvL3VuaWNvZGUvY2F0ZWdvcnkvWnMvbGlzdC5odG0+XG4gICAqL1xuICB0cmltbWVkPzogYm9vbGVhbjtcbiAgbWluQ29kZXBvaW50cz86IG51bWJlcjtcbiAgbWF4Q29kZXBvaW50czogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ29kZXBvaW50U3RyaW5nVHlwZSBpbXBsZW1lbnRzIFZlcnNpb25lZFR5cGU8c3RyaW5nLCBqc29uLklucHV0LCBqc29uLk91dHB1dCwgRGlmZj4ge1xuXG4gIHJlYWRvbmx5IG5hbWU6IE5hbWUgPSBuYW1lO1xuICByZWFkb25seSBub3JtYWxpemF0aW9uOiBOb3JtYWxpemF0aW9uO1xuICByZWFkb25seSBlbmZvcmNlVW5pY29kZVJlZ0V4cDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgcGF0dGVybj86IFJlZ0V4cDtcbiAgcmVhZG9ubHkgbG93ZXJDYXNlOiBib29sZWFuO1xuICByZWFkb25seSB0cmltbWVkOiBib29sZWFuO1xuICByZWFkb25seSBtaW5Db2RlcG9pbnRzPzogbnVtYmVyO1xuICByZWFkb25seSBtYXhDb2RlcG9pbnRzOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogTGF6eTxDb2RlcG9pbnRTdHJpbmdPcHRpb25zPjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBMYXp5PENvZGVwb2ludFN0cmluZ09wdGlvbnM+KSB7XG4gICAgLy8gVE9ETzogUmVtb3ZlIG9uY2UgVFMgMi43IGlzIGJldHRlciBzdXBwb3J0ZWQgYnkgZWRpdG9yc1xuICAgIHRoaXMubm9ybWFsaXphdGlvbiA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLmVuZm9yY2VVbmljb2RlUmVnRXhwID0gPGFueT4gdW5kZWZpbmVkO1xuICAgIHRoaXMubG93ZXJDYXNlID0gPGFueT4gdW5kZWZpbmVkO1xuICAgIHRoaXMudHJpbW1lZCA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLm1heENvZGVwb2ludHMgPSA8YW55PiB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucztcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgdGhpcy5fYXBwbHlPcHRpb25zKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxhenlQcm9wZXJ0aWVzKFxuICAgICAgICB0aGlzLFxuICAgICAgICB0aGlzLl9hcHBseU9wdGlvbnMsXG4gICAgICAgIFtcIm5vcm1hbGl6YXRpb25cIiwgXCJlbmZvcmNlVW5pY29kZVJlZ0V4cFwiLCBcInBhdHRlcm5cIiwgXCJsb3dlckNhc2VcIiwgXCJ0cmltbWVkXCIsIFwibWluQ29kZXBvaW50c1wiLCBcIm1heENvZGVwb2ludHNcIl0sXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBmcm9tSlNPTihvcHRpb25zOiBqc29uLlR5cGUpOiBDb2RlcG9pbnRTdHJpbmdUeXBlIHtcbiAgICBjb25zdCByZXNvbHZlZE9wdGlvbnM6IENvZGVwb2ludFN0cmluZ09wdGlvbnMgPSB7XG4gICAgICBub3JtYWxpemF0aW9uOiBvcHRpb25zLm5vcm1hbGl6YXRpb24gPT09IFwibm9uZVwiID8gTm9ybWFsaXphdGlvbi5Ob25lIDogTm9ybWFsaXphdGlvbi5OZmMsXG4gICAgICBlbmZvcmNlVW5pY29kZVJlZ0V4cDogb3B0aW9ucy5lbmZvcmNlVW5pY29kZVJlZ0V4cCxcbiAgICAgIGxvd2VyQ2FzZTogb3B0aW9ucy5sb3dlckNhc2UsXG4gICAgICB0cmltbWVkOiBvcHRpb25zLnRyaW1tZWQsXG4gICAgICBtYXhDb2RlcG9pbnRzOiBvcHRpb25zLm1heENvZGVwb2ludHMsXG4gICAgfTtcbiAgICBpZiAob3B0aW9ucy5wYXR0ZXJuICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlc29sdmVkT3B0aW9ucy5wYXR0ZXJuID0gbmV3IFJlZ0V4cChvcHRpb25zLnBhdHRlcm5bMF0sIG9wdGlvbnMucGF0dGVyblsxXSk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLm1pbkNvZGVwb2ludHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzb2x2ZWRPcHRpb25zLm1pbkNvZGVwb2ludHMgPSBvcHRpb25zLm1pbkNvZGVwb2ludHM7XG4gICAgfVxuICAgIHJldHVybiBuZXcgQ29kZXBvaW50U3RyaW5nVHlwZShyZXNvbHZlZE9wdGlvbnMpO1xuICB9XG5cbiAgdG9KU09OKCk6IGpzb24uVHlwZSB7XG4gICAgY29uc3QganNvblR5cGU6IGpzb24uVHlwZSA9IHtcbiAgICAgIG5hbWUsXG4gICAgICBub3JtYWxpemF0aW9uOiB0aGlzLm5vcm1hbGl6YXRpb24gPT09IE5vcm1hbGl6YXRpb24uTm9uZSA/IFwibm9uZVwiIDogXCJuZmNcIixcbiAgICAgIGVuZm9yY2VVbmljb2RlUmVnRXhwOiB0aGlzLmVuZm9yY2VVbmljb2RlUmVnRXhwLFxuICAgICAgbG93ZXJDYXNlOiB0aGlzLmxvd2VyQ2FzZSxcbiAgICAgIHRyaW1tZWQ6IHRoaXMudHJpbW1lZCxcbiAgICAgIG1heENvZGVwb2ludHM6IHRoaXMubWF4Q29kZXBvaW50cyxcbiAgICB9O1xuICAgIGlmICh0aGlzLnBhdHRlcm4gIT09IHVuZGVmaW5lZCkge1xuICAgICAganNvblR5cGUucGF0dGVybiA9IFt0aGlzLnBhdHRlcm4uc291cmNlLCB0aGlzLnBhdHRlcm4uZmxhZ3NdO1xuICAgIH1cbiAgICBpZiAodGhpcy5taW5Db2RlcG9pbnRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGpzb25UeXBlLm1pbkNvZGVwb2ludHMgPSB0aGlzLm1pbkNvZGVwb2ludHM7XG4gICAgfVxuICAgIHJldHVybiBqc29uVHlwZTtcbiAgfVxuXG4gIHJlYWRUcnVzdGVkSnNvbihpbnB1dDoganNvbi5PdXRwdXQpOiBzdHJpbmcge1xuICAgIHJldHVybiBpbnB1dDtcbiAgfVxuXG4gIHJlYWRKc29uKGlucHV0OiBhbnkpOiBzdHJpbmcge1xuICAgIGNvbnN0IGVycm9yOiBFcnJvciB8IHVuZGVmaW5lZCA9IHRoaXMudGVzdEVycm9yKGlucHV0KTtcbiAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIHJldHVybiBpbnB1dDtcbiAgfVxuXG4gIHdyaXRlSnNvbih2YWw6IHN0cmluZyk6IGpzb24uT3V0cHV0IHtcbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgdGVzdEVycm9yKHZhbDogc3RyaW5nKTogRXJyb3IgfCB1bmRlZmluZWQge1xuICAgIGlmICghKHR5cGVvZiB2YWwgPT09IFwic3RyaW5nXCIpKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcInN0cmluZ1wiLCB2YWwpO1xuICAgIH1cblxuICAgIHN3aXRjaCAodGhpcy5ub3JtYWxpemF0aW9uKSB7XG4gICAgICBjYXNlIE5vcm1hbGl6YXRpb24uTmZjOlxuICAgICAgICBpZiAodW5vcm1OZmMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHRocm93IGNyZWF0ZU1pc3NpbmdEZXBlbmRlbmN5RXJyb3IoXCJ1bm9ybVwiLCBcIlJlcXVpcmVkIHRvIG5vcm1hbGl6ZSB1bmljb2RlIHN0cmluZ3MgdG8gTkZDLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFsICE9PSB1bm9ybU5mYyh2YWwpKSB7XG4gICAgICAgICAgcmV0dXJuIEluY2lkZW50KFwiVW5pY29kZU5vcm1hbGl6YXRpb25cIiwgXCJOb3QgTkZDLU5vcm1hbGl6ZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE5vcm1hbGl6YXRpb24uTm9uZTpcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXG4gICAgICAgICAgYEluY29tcGxldGVTd2l0Y2g6IFJlY2VpdmVkIHVuZXhwZWN0ZWQgdmFyaWFudCBmb3IgdGhpcy5ub3JtYWxpemF0aW9uOiAke3RoaXMubm9ybWFsaXphdGlvbn1gLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmxvd2VyQ2FzZSAmJiB2YWwgIT09IHZhbC50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICByZXR1cm4gY3JlYXRlTG93ZXJDYXNlRXJyb3IodmFsKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50cmltbWVkICYmIHZhbCAhPT0gdmFsLnRyaW0oKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZU5vdFRyaW1tZWRFcnJvcih2YWwpO1xuICAgIH1cblxuICAgIGxldCBjb2RlcG9pbnRDb3VudDogbnVtYmVyO1xuICAgIHRyeSB7XG4gICAgICBjb2RlcG9pbnRDb3VudCA9IGNoZWNrZWRVY3MyRGVjb2RlKHZhbCkubGVuZ3RoO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIGVycjtcbiAgICB9XG5cbiAgICBjb25zdCBtaW5Db2RlcG9pbnRzOiBudW1iZXIgfCB1bmRlZmluZWQgPSB0aGlzLm1pbkNvZGVwb2ludHM7XG4gICAgaWYgKHR5cGVvZiBtaW5Db2RlcG9pbnRzID09PSBcIm51bWJlclwiICYmIGNvZGVwb2ludENvdW50IDwgbWluQ29kZXBvaW50cykge1xuICAgICAgcmV0dXJuIGNyZWF0ZU1pbkNvZGVwb2ludHNFcnJvcih2YWwsIGNvZGVwb2ludENvdW50LCBtaW5Db2RlcG9pbnRzKTtcbiAgICB9XG5cbiAgICBpZiAoY29kZXBvaW50Q291bnQgPiB0aGlzLm1heENvZGVwb2ludHMpIHtcbiAgICAgIHJldHVybiBjcmVhdGVNYXhDb2RlcG9pbnRzRXJyb3IodmFsLCBjb2RlcG9pbnRDb3VudCwgdGhpcy5tYXhDb2RlcG9pbnRzKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwKSB7XG4gICAgICBpZiAoIXRoaXMucGF0dGVybi51bmljb2RlICYmIHRoaXMuZW5mb3JjZVVuaWNvZGVSZWdFeHApIHtcbiAgICAgICAgdGhyb3cgbmV3IEluY2lkZW50KFxuICAgICAgICAgIFwiTm9uVW5pY29kZVJlZ0V4cFwiLFxuICAgICAgICAgIFwiRW5mb3JjZWQgdW5pY29kZSBSZWdFeHAsIHVzZSBgZW5mb3JjZVVuaWNvZGVSZWdFeHAgPSBmYWxzZWAgb3IgYFVjczJTdHJpbmdUeXBlYFwiLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMucGF0dGVybi50ZXN0KHZhbCkpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZVBhdHRlcm5Ob3RNYXRjaGVkRXJyb3IodGhpcy5wYXR0ZXJuLCB2YWwpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudGVzdEVycm9yKHZhbCkgPT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGVxdWFscyh2YWwxOiBzdHJpbmcsIHZhbDI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2YWwxID09PSB2YWwyO1xuICB9XG5cbiAgY2xvbmUodmFsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB2YWw7XG4gIH1cblxuICBkaWZmKG9sZFZhbDogc3RyaW5nLCBuZXdWYWw6IHN0cmluZyk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiBvbGRWYWwgPT09IG5ld1ZhbCA/IHVuZGVmaW5lZCA6IFtvbGRWYWwsIG5ld1ZhbF07XG4gIH1cblxuICBwYXRjaChvbGRWYWw6IHN0cmluZywgZGlmZjogRGlmZiB8IHVuZGVmaW5lZCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGRpZmYgPT09IHVuZGVmaW5lZCA/IG9sZFZhbCA6IGRpZmZbMV07XG4gIH1cblxuICByZXZlcnNlRGlmZihkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIGRpZmYgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IFtkaWZmWzFdLCBkaWZmWzBdXTtcbiAgfVxuXG4gIHNxdWFzaChkaWZmMTogRGlmZiB8IHVuZGVmaW5lZCwgZGlmZjI6IERpZmYgfCB1bmRlZmluZWQpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoZGlmZjEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGRpZmYyID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBbZGlmZjJbMF0sIGRpZmYyWzFdXTtcbiAgICB9IGVsc2UgaWYgKGRpZmYyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbZGlmZjFbMF0sIGRpZmYxWzFdXTtcbiAgICB9XG4gICAgcmV0dXJuIGRpZmYxWzBdID09PSBkaWZmMlsxXSA/IHVuZGVmaW5lZCA6IFtkaWZmMVswXSwgZGlmZjJbMV1dO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlPcHRpb25zKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9vcHRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IodGhpcyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnM6IENvZGVwb2ludFN0cmluZ09wdGlvbnMgPSB0eXBlb2YgdGhpcy5fb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiID8gdGhpcy5fb3B0aW9ucygpIDogdGhpcy5fb3B0aW9ucztcblxuICAgIGNvbnN0IG5vcm1hbGl6YXRpb246IE5vcm1hbGl6YXRpb24gPSBvcHRpb25zLm5vcm1hbGl6YXRpb24gIT09IHVuZGVmaW5lZCA/XG4gICAgICBvcHRpb25zLm5vcm1hbGl6YXRpb24gOlxuICAgICAgTm9ybWFsaXphdGlvbi5OZmM7XG4gICAgY29uc3QgZW5mb3JjZVVuaWNvZGVSZWdFeHA6IGJvb2xlYW4gPSBvcHRpb25zLmVuZm9yY2VVbmljb2RlUmVnRXhwICE9PSB1bmRlZmluZWQgP1xuICAgICAgb3B0aW9ucy5lbmZvcmNlVW5pY29kZVJlZ0V4cCA6XG4gICAgICB0cnVlO1xuICAgIGNvbnN0IHBhdHRlcm46IFJlZ0V4cCB8IHVuZGVmaW5lZCA9IG9wdGlvbnMucGF0dGVybjtcbiAgICBjb25zdCBsb3dlckNhc2U6IGJvb2xlYW4gPSBvcHRpb25zLmxvd2VyQ2FzZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5sb3dlckNhc2UgOiBmYWxzZTtcbiAgICBjb25zdCB0cmltbWVkOiBib29sZWFuID0gb3B0aW9ucy50cmltbWVkICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRyaW1tZWQgOiBmYWxzZTtcbiAgICBjb25zdCBtaW5Db2RlcG9pbnRzOiBudW1iZXIgfCB1bmRlZmluZWQgPSBvcHRpb25zLm1pbkNvZGVwb2ludHM7XG4gICAgY29uc3QgbWF4Q29kZXBvaW50czogbnVtYmVyID0gb3B0aW9ucy5tYXhDb2RlcG9pbnRzO1xuXG4gICAgT2JqZWN0LmFzc2lnbihcbiAgICAgIHRoaXMsXG4gICAgICB7bm9ybWFsaXphdGlvbiwgZW5mb3JjZVVuaWNvZGVSZWdFeHAsIHBhdHRlcm4sIGxvd2VyQ2FzZSwgdHJpbW1lZCwgbWluQ29kZXBvaW50cywgbWF4Q29kZXBvaW50c30sXG4gICAgKTtcbiAgICBPYmplY3QuZnJlZXplKHRoaXMpO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii4uIn0=
