"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const lazy_properties_1 = require("../_helpers/lazy-properties");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
const not_implemented_1 = require("../errors/not-implemented");
exports.name = "map";
class MapType {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.keyType = undefined;
        this.valueType = undefined;
        this.maxSize = undefined;
        this.assumeStringKey = undefined;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["keyType", "valueType", "maxSize", "assumeStringKey"]);
        }
    }
    toJSON() {
        throw not_implemented_1.createNotImplementedError("MapType#toJSON");
    }
    readTrustedJson(input) {
        const result = new Map();
        for (const keyString in input) {
            const key = this.keyType.readTrustedJson(JSON.parse(keyString));
            const value = this.valueType.readTrustedJson(input[keyString]);
            result.set(key, value);
        }
        return result;
    }
    readJson(input) {
        if (typeof input !== "object" || input === null) {
            throw invalid_type_1.createInvalidTypeError("object", input);
        }
        const result = new Map();
        for (const keyString in input) {
            let rawKey;
            try {
                rawKey = JSON.parse(keyString);
            }
            catch (err) {
                throw err;
            }
            const key = this.keyType.readJson(rawKey);
            const value = this.valueType.readJson(input[keyString]);
            result.set(key, value);
        }
        const error = this.testError(result);
        if (error !== undefined) {
            throw error;
        }
        return result;
    }
    writeJson(val) {
        const result = {};
        for (const [key, value] of val) {
            const rawKey = this.keyType.writeJson(key);
            const keyString = JSON.stringify(rawKey);
            // TODO(demurgos): Check for duplicate keys
            result[keyString] = this.valueType.writeJson(value);
        }
        return result;
    }
    testError(val) {
        if (!(val instanceof Map)) {
            return invalid_type_1.createInvalidTypeError("Map", val);
        }
        for (const [key, value] of val) {
            // TODO: test keyType
            const keyError = this.keyType.testError(key);
            if (keyError !== undefined) {
                return new incident_1.Incident("InvalidMapKey", { key, value }, "Invalid map entry: invalid key");
            }
            const valueError = this.valueType.testError(value);
            if (valueError !== undefined) {
                return new incident_1.Incident("InvalidMapValue", { key, value }, "Invalid map entry: invalid value");
            }
        }
        return undefined;
    }
    test(val) {
        return this.testError(val) === undefined;
    }
    equals(val1, val2) {
        if (val2.size !== val1.size) {
            return false;
        }
        // TODO(demurgos): This test is brittle (order-sensitive) and involves unnecessary serialization.
        const val1Json = JSON.stringify(this.writeJson(val1));
        const val2Json = JSON.stringify(this.writeJson(val2));
        return val1Json === val2Json;
    }
    clone(val) {
        const result = new Map();
        for (const [key, value] of val) {
            const keyClone = this.keyType.clone(key);
            const valueClone = this.valueType.clone(value);
            result.set(key, value);
        }
        return result;
    }
    diff(oldVal, newVal) {
        throw not_implemented_1.createNotImplementedError("MapType#diff");
    }
    patch(oldVal, diff) {
        throw not_implemented_1.createNotImplementedError("MapType#patch");
    }
    reverseDiff(diff) {
        throw not_implemented_1.createNotImplementedError("MapType#reverseDiff");
    }
    squash(diff1, diff2) {
        throw not_implemented_1.createNotImplementedError("MapType#squash");
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const keyType = options.keyType;
        const valueType = options.valueType;
        const maxSize = options.maxSize;
        const assumeStringKey = options.assumeStringKey || false;
        Object.assign(this, { keyType, valueType, maxSize, assumeStringKey });
        Object.freeze(this);
    }
}
exports.MapType = MapType;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDO1FBQ3hDLE1BQU0sZUFBZSxHQUFZLE9BQU8sQ0FBQyxlQUFlLElBQUksS0FBSyxDQUFDO1FBRWxFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFDLENBQUMsQ0FBQztRQUNwRSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQWhKRCwwQkFnSkMiLCJmaWxlIjoidHlwZXMvbWFwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5jaWRlbnQgfSBmcm9tIFwiaW5jaWRlbnRcIjtcbmltcG9ydCB7IGxhenlQcm9wZXJ0aWVzIH0gZnJvbSBcIi4uL19oZWxwZXJzL2xhenktcHJvcGVydGllc1wiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZFR5cGVFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC10eXBlXCI7XG5pbXBvcnQgeyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9sYXp5LW9wdGlvbnNcIjtcbmltcG9ydCB7IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL25vdC1pbXBsZW1lbnRlZFwiO1xuaW1wb3J0IHsgTGF6eSwgVmVyc2lvbmVkVHlwZSB9IGZyb20gXCIuLi90eXBlc1wiO1xuXG5leHBvcnQgdHlwZSBOYW1lID0gXCJtYXBcIjtcbmV4cG9ydCBjb25zdCBuYW1lOiBOYW1lID0gXCJtYXBcIjtcbmV4cG9ydCBuYW1lc3BhY2UganNvbiB7XG4gIGV4cG9ydCBpbnRlcmZhY2UgSW5wdXQge1xuICAgIFtrZXk6IHN0cmluZ106IGFueTtcbiAgfVxuXG4gIGV4cG9ydCBpbnRlcmZhY2UgT3V0cHV0IHtcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XG4gIH1cblxuICAvLyBUT0RPKGRlbXVyZ29zKTogRXhwb3J0IGFycmF5VHlwZSB0byBKU09OXG4gIGV4cG9ydCB0eXBlIFR5cGUgPSB1bmRlZmluZWQ7XG59XG5leHBvcnQgdHlwZSBEaWZmID0gYW55O1xuXG5leHBvcnQgaW50ZXJmYWNlIE1hcFR5cGVPcHRpb25zPEssIFY+IHtcbiAga2V5VHlwZTogVmVyc2lvbmVkVHlwZTxLLCBhbnksIGFueSwgYW55PjtcbiAgdmFsdWVUeXBlOiBWZXJzaW9uZWRUeXBlPFYsIGFueSwgYW55LCBhbnk+O1xuICBtYXhTaXplOiBudW1iZXI7XG4gIGFzc3VtZVN0cmluZ0tleT86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBNYXBUeXBlPEssIFY+IGltcGxlbWVudHMgVmVyc2lvbmVkVHlwZTxNYXA8SywgVj4sIGpzb24uSW5wdXQsIGpzb24uT3V0cHV0LCBEaWZmPiB7XG4gIHJlYWRvbmx5IG5hbWU6IE5hbWUgPSBuYW1lO1xuICByZWFkb25seSBrZXlUeXBlOiBWZXJzaW9uZWRUeXBlPEssIGFueSwgYW55LCBhbnk+O1xuICByZWFkb25seSB2YWx1ZVR5cGU6IFZlcnNpb25lZFR5cGU8ViwgYW55LCBhbnksIGFueT47XG4gIHJlYWRvbmx5IG1heFNpemU6IG51bWJlcjtcbiAgcmVhZG9ubHkgYXNzdW1lU3RyaW5nS2V5OiBib29sZWFuO1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IExhenk8TWFwVHlwZU9wdGlvbnM8SywgVj4+O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IExhenk8TWFwVHlwZU9wdGlvbnM8SywgVj4+KSB7XG4gICAgLy8gVE9ETzogUmVtb3ZlIG9uY2UgVFMgMi43IGlzIGJldHRlciBzdXBwb3J0ZWQgYnkgZWRpdG9yc1xuICAgIHRoaXMua2V5VHlwZSA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLnZhbHVlVHlwZSA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLm1heFNpemUgPSA8YW55PiB1bmRlZmluZWQ7XG4gICAgdGhpcy5hc3N1bWVTdHJpbmdLZXkgPSA8YW55PiB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucztcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgdGhpcy5fYXBwbHlPcHRpb25zKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxhenlQcm9wZXJ0aWVzKHRoaXMsIHRoaXMuX2FwcGx5T3B0aW9ucywgW1wia2V5VHlwZVwiLCBcInZhbHVlVHlwZVwiLCBcIm1heFNpemVcIiwgXCJhc3N1bWVTdHJpbmdLZXlcIl0pO1xuICAgIH1cbiAgfVxuXG4gIHRvSlNPTigpOiBqc29uLlR5cGUge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJNYXBUeXBlI3RvSlNPTlwiKTtcbiAgfVxuXG4gIHJlYWRUcnVzdGVkSnNvbihpbnB1dDoganNvbi5PdXRwdXQpOiBNYXA8SywgVj4ge1xuICAgIGNvbnN0IHJlc3VsdDogTWFwPEssIFY+ID0gbmV3IE1hcCgpO1xuICAgIGZvciAoY29uc3Qga2V5U3RyaW5nIGluIGlucHV0KSB7XG4gICAgICBjb25zdCBrZXk6IEsgPSB0aGlzLmtleVR5cGUucmVhZFRydXN0ZWRKc29uKEpTT04ucGFyc2Uoa2V5U3RyaW5nKSk7XG4gICAgICBjb25zdCB2YWx1ZTogViA9IHRoaXMudmFsdWVUeXBlLnJlYWRUcnVzdGVkSnNvbihpbnB1dFtrZXlTdHJpbmddKTtcbiAgICAgIHJlc3VsdC5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICByZWFkSnNvbihpbnB1dDogYW55KTogTWFwPEssIFY+IHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcIm9iamVjdFwiIHx8IGlucHV0ID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwib2JqZWN0XCIsIGlucHV0KTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0OiBNYXA8SywgVj4gPSBuZXcgTWFwKCk7XG4gICAgZm9yIChjb25zdCBrZXlTdHJpbmcgaW4gaW5wdXQpIHtcbiAgICAgIGxldCByYXdLZXk6IGFueTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJhd0tleSA9IEpTT04ucGFyc2Uoa2V5U3RyaW5nKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgICBjb25zdCBrZXk6IEsgPSB0aGlzLmtleVR5cGUucmVhZEpzb24ocmF3S2V5KTtcbiAgICAgIGNvbnN0IHZhbHVlOiBWID0gdGhpcy52YWx1ZVR5cGUucmVhZEpzb24oaW5wdXRba2V5U3RyaW5nXSk7XG4gICAgICByZXN1bHQuc2V0KGtleSwgdmFsdWUpO1xuICAgIH1cbiAgICBjb25zdCBlcnJvcjogRXJyb3IgfCB1bmRlZmluZWQgPSB0aGlzLnRlc3RFcnJvcihyZXN1bHQpO1xuICAgIGlmIChlcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHdyaXRlSnNvbih2YWw6IE1hcDxLLCBWPik6IGpzb24uT3V0cHV0IHtcbiAgICBjb25zdCByZXN1bHQ6IHtba2V5OiBzdHJpbmddOiBhbnl9ID0ge307XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdmFsKSB7XG4gICAgICBjb25zdCByYXdLZXk6IGFueSA9IHRoaXMua2V5VHlwZS53cml0ZUpzb24oa2V5KTtcbiAgICAgIGNvbnN0IGtleVN0cmluZzogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkocmF3S2V5KTtcbiAgICAgIC8vIFRPRE8oZGVtdXJnb3MpOiBDaGVjayBmb3IgZHVwbGljYXRlIGtleXNcbiAgICAgIHJlc3VsdFtrZXlTdHJpbmddID0gdGhpcy52YWx1ZVR5cGUud3JpdGVKc29uKHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IE1hcDxLLCBWPik6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoISh2YWwgaW5zdGFuY2VvZiBNYXApKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIk1hcFwiLCB2YWwpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB2YWwpIHtcbiAgICAgIC8vIFRPRE86IHRlc3Qga2V5VHlwZVxuICAgICAgY29uc3Qga2V5RXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkID0gdGhpcy5rZXlUeXBlLnRlc3RFcnJvcihrZXkpO1xuICAgICAgaWYgKGtleUVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBJbmNpZGVudChcIkludmFsaWRNYXBLZXlcIiwge2tleSwgdmFsdWV9LCBcIkludmFsaWQgbWFwIGVudHJ5OiBpbnZhbGlkIGtleVwiKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlRXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkID0gdGhpcy52YWx1ZVR5cGUudGVzdEVycm9yKHZhbHVlKTtcbiAgICAgIGlmICh2YWx1ZUVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBJbmNpZGVudChcIkludmFsaWRNYXBWYWx1ZVwiLCB7a2V5LCB2YWx1ZX0sIFwiSW52YWxpZCBtYXAgZW50cnk6IGludmFsaWQgdmFsdWVcIik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogTWFwPEssIFY+KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudGVzdEVycm9yKHZhbCkgPT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGVxdWFscyh2YWwxOiBNYXA8SywgVj4sIHZhbDI6IE1hcDxLLCBWPik6IGJvb2xlYW4ge1xuICAgIGlmICh2YWwyLnNpemUgIT09IHZhbDEuc2l6ZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICAvLyBUT0RPKGRlbXVyZ29zKTogVGhpcyB0ZXN0IGlzIGJyaXR0bGUgKG9yZGVyLXNlbnNpdGl2ZSkgYW5kIGludm9sdmVzIHVubmVjZXNzYXJ5IHNlcmlhbGl6YXRpb24uXG4gICAgY29uc3QgdmFsMUpzb246IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHRoaXMud3JpdGVKc29uKHZhbDEpKTtcbiAgICBjb25zdCB2YWwySnNvbjogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkodGhpcy53cml0ZUpzb24odmFsMikpO1xuICAgIHJldHVybiB2YWwxSnNvbiA9PT0gdmFsMkpzb247XG4gIH1cblxuICBjbG9uZSh2YWw6IE1hcDxLLCBWPik6IE1hcDxLLCBWPiB7XG4gICAgY29uc3QgcmVzdWx0OiBNYXA8SywgVj4gPSBuZXcgTWFwKCk7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdmFsKSB7XG4gICAgICBjb25zdCBrZXlDbG9uZTogSyA9IHRoaXMua2V5VHlwZS5jbG9uZShrZXkpO1xuICAgICAgY29uc3QgdmFsdWVDbG9uZTogViA9IHRoaXMudmFsdWVUeXBlLmNsb25lKHZhbHVlKTtcbiAgICAgIHJlc3VsdC5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBkaWZmKG9sZFZhbDogTWFwPEssIFY+LCBuZXdWYWw6IE1hcDxLLCBWPik6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJNYXBUeXBlI2RpZmZcIik7XG4gIH1cblxuICBwYXRjaChvbGRWYWw6IE1hcDxLLCBWPiwgZGlmZjogRGlmZiB8IHVuZGVmaW5lZCk6IE1hcDxLLCBWPiB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIk1hcFR5cGUjcGF0Y2hcIik7XG4gIH1cblxuICByZXZlcnNlRGlmZihkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIk1hcFR5cGUjcmV2ZXJzZURpZmZcIik7XG4gIH1cblxuICBzcXVhc2goZGlmZjE6IERpZmYgfCB1bmRlZmluZWQsIGRpZmYyOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIk1hcFR5cGUjc3F1YXNoXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlPcHRpb25zKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9vcHRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IodGhpcyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnM6IE1hcFR5cGVPcHRpb25zPEssIFY+ID0gdHlwZW9mIHRoaXMuX29wdGlvbnMgPT09IFwiZnVuY3Rpb25cIiA/IHRoaXMuX29wdGlvbnMoKSA6IHRoaXMuX29wdGlvbnM7XG5cbiAgICBjb25zdCBrZXlUeXBlOiBWZXJzaW9uZWRUeXBlPEssIGFueSwgYW55LCBhbnk+ID0gb3B0aW9ucy5rZXlUeXBlO1xuICAgIGNvbnN0IHZhbHVlVHlwZTogVmVyc2lvbmVkVHlwZTxWLCBhbnksIGFueSwgYW55PiA9IG9wdGlvbnMudmFsdWVUeXBlO1xuICAgIGNvbnN0IG1heFNpemU6IG51bWJlciA9IG9wdGlvbnMubWF4U2l6ZTtcbiAgICBjb25zdCBhc3N1bWVTdHJpbmdLZXk6IGJvb2xlYW4gPSBvcHRpb25zLmFzc3VtZVN0cmluZ0tleSB8fCBmYWxzZTtcblxuICAgIE9iamVjdC5hc3NpZ24odGhpcywge2tleVR5cGUsIHZhbHVlVHlwZSwgbWF4U2l6ZSwgYXNzdW1lU3RyaW5nS2V5fSk7XG4gICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLiJ9
