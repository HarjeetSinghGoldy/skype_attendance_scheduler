"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const lazy_properties_1 = require("../_helpers/lazy-properties");
const case_style_1 = require("../case-style");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
const not_implemented_1 = require("../errors/not-implemented");
exports.name = "simple-enum";
/**
 * Supports enums from keys that are valid Javascript identifiers to unique integer values
 */
class SimpleEnumType {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.enum = undefined;
        this.outputNameToValue = undefined;
        this.valueToOutputName = undefined;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["enum", "rename", "outputNameToValue", "valueToOutputName"]);
        }
    }
    static fromJSON() {
        throw not_implemented_1.createNotImplementedError("SimpleEnumType.fromJSON");
    }
    toJSON() {
        throw not_implemented_1.createNotImplementedError("SimpleEnumType#toJSON");
    }
    readTrustedJson(input) {
        return this.outputNameToValue[input];
    }
    readJson(input) {
        if (typeof input !== "string") {
            throw invalid_type_1.createInvalidTypeError("string", input);
        }
        if (!this.outputNameToValue.hasOwnProperty(input)) {
            throw incident_1.Incident("Unknown enum variant name", input);
        }
        return this.outputNameToValue[input];
    }
    writeJson(val) {
        return this.valueToOutputName[val];
    }
    testError(val) {
        if (typeof val !== "number") {
            return invalid_type_1.createInvalidTypeError("number", val);
        }
        // TODO(demurgos): Remove <number> once typedoc supports it
        if (isNaN(val) || val === Infinity || val === -Infinity || (val | 0) !== val) {
            return invalid_type_1.createInvalidTypeError("int32", val);
        }
        if (!this.enum.hasOwnProperty(val)) {
            return incident_1.Incident("UnknownVariantError", { value: val }, "Unknown enum variant value");
        }
        return undefined;
    }
    test(val) {
        return typeof val === "number" && this.enum.hasOwnProperty(val);
    }
    equals(val1, val2) {
        return val1 === val2;
    }
    clone(val) {
        return val;
    }
    diff(oldVal, newVal) {
        return newVal === oldVal ? undefined : newVal - oldVal;
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : oldVal + diff;
    }
    reverseDiff(diff) {
        /* tslint:disable-next-line:strict-boolean-expressions */
        return diff && -diff;
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2;
        }
        else if (diff2 === undefined) {
            return diff1;
        }
        return diff2 === -diff1 ? undefined : diff1 + diff2;
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const baseEnum = options.enum;
        const renameAll = options.rename;
        const outputNameToValue = {};
        const valueToOutputName = {};
        for (const key in baseEnum) {
            if (/^\d+$/.test(key)) {
                continue;
            }
            const value = options.enum[key];
            if (typeof value !== "number") {
                throw invalid_type_1.createInvalidTypeError("number", value);
            }
            if (!baseEnum.hasOwnProperty(value) || !baseEnum.hasOwnProperty(value)) {
                throw new incident_1.Incident("NotSimpleEnum", "Not owned key or value");
            }
            if (baseEnum[value] !== key) {
                throw new incident_1.Incident("NotReversibleEnum", "enum[enum[key]] !== key");
            }
            let renamed;
            if (renameAll === undefined) {
                renamed = key;
            }
            else {
                renamed = case_style_1.rename(key, renameAll);
            }
            outputNameToValue[renamed] = value;
            valueToOutputName[value] = renamed;
        }
        Object.assign(this, { enum: baseEnum, rename: renameAll, outputNameToValue, valueToOutputName });
        Object.freeze(this);
    }
}
exports.SimpleEnumType = SimpleEnumType;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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bUJBQVEsQ0FBQyxlQUFlLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztZQUNoRSxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQVEsUUFBUSxDQUFDLEtBQUssQ0FBWSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzlDLE1BQU0sSUFBSSxtQkFBUSxDQUFDLG1CQUFtQixFQUFFLHlCQUF5QixDQUFDLENBQUM7WUFDckUsQ0FBQztZQUNELElBQUksT0FBZSxDQUFDO1lBQ3BCLEVBQUUsQ0FBQyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixPQUFPLEdBQUcsR0FBRyxDQUFDO1lBQ2hCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixPQUFPLEdBQUcsbUJBQU0sQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDbkMsQ0FBQztZQUNELGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNuQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxPQUFPLENBQUM7UUFDckMsQ0FBQztRQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUFDLENBQUMsQ0FBQztRQUMvRixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQXZJRCx3Q0F1SUMiLCJmaWxlIjoidHlwZXMvc2ltcGxlLWVudW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgbGF6eVByb3BlcnRpZXMgfSBmcm9tIFwiLi4vX2hlbHBlcnMvbGF6eS1wcm9wZXJ0aWVzXCI7XG5pbXBvcnQgeyBDYXNlU3R5bGUsIHJlbmFtZSB9IGZyb20gXCIuLi9jYXNlLXN0eWxlXCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLXR5cGVcIjtcbmltcG9ydCB7IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2xhenktb3B0aW9uc1wiO1xuaW1wb3J0IHsgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbm90LWltcGxlbWVudGVkXCI7XG5pbXBvcnQgeyBMYXp5LCBWZXJzaW9uZWRUeXBlIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmV4cG9ydCB0eXBlIFNpbXBsZUVudW08RW51bUNvbnN0cnVjdG9yPiA9IHtbSyBpbiBrZXlvZiBFbnVtQ29uc3RydWN0b3JdOiBFbnVtQ29uc3RydWN0b3JbS119O1xuXG5pbnRlcmZhY2UgUmV2ZXJzZWRFbnVtPEVDPiB7XG4gIFtpbmRleDogbnVtYmVyXTogKGtleW9mIEVDKSB8IHVuZGVmaW5lZDtcbn1cblxudHlwZSBEb3VibGVFbnVtPEVDPiA9IFNpbXBsZUVudW08RUM+ICYgUmV2ZXJzZWRFbnVtPEVDPjtcblxuZXhwb3J0IGludGVyZmFjZSBBbnlTaW1wbGVFbnVtIHtcbiAgW25hbWU6IHN0cmluZ106IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBbnlSZXZlcnNlZEVudW0ge1xuICBbdmFsdWU6IG51bWJlcl06IHN0cmluZztcbn1cblxudHlwZSBBbnlEb3VibGVFbnVtID0gQW55U2ltcGxlRW51bSAmIEFueVJldmVyc2VkRW51bTtcblxuLy8gVGhpcyBpcyBzdHJpY3RseSBhbiBhbGlhcyBmb3IgYG51bWJlcmAgZm9yIHRoZSBtb21lbnQgc2luY2UgVHlwZXNjcmlwdFxuLy8gZG9lcyBub3QgdXNlIHVuaW9uIHR5cGVzIGZvciBlbnVtIHZhbHVlcyAoYXMgb2YgVFMgMi4zKVxuZXhwb3J0IGludGVyZmFjZSBFbnVtQ29uc3RydWN0b3I8RW51bVZhbHVlIGV4dGVuZHMgbnVtYmVyPiB7XG4gIFtuYW1lOiBzdHJpbmddOiBFbnVtVmFsdWU7XG59XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcInNpbXBsZS1lbnVtXCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwic2ltcGxlLWVudW1cIjtcbmV4cG9ydCBuYW1lc3BhY2UganNvbiB7XG4gIGV4cG9ydCB0eXBlIElucHV0ID0gc3RyaW5nO1xuICBleHBvcnQgdHlwZSBPdXRwdXQgPSBzdHJpbmc7XG5cbiAgZXhwb3J0IGludGVyZmFjZSBUeXBlIHtcbiAgICBuYW1lOiBOYW1lO1xuICAgIGVudW06IEVudW1Db25zdHJ1Y3RvcjxudW1iZXI+O1xuICB9XG59XG5leHBvcnQgdHlwZSBEaWZmID0gbnVtYmVyO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNpbXBsZUVudW1UeXBlT3B0aW9uczxFIGV4dGVuZHMgbnVtYmVyPiB7XG4gIGVudW06IEVudW1Db25zdHJ1Y3RvcjxFPiB8IE9iamVjdDtcbiAgcmVuYW1lPzogQ2FzZVN0eWxlO1xufVxuXG4vKipcbiAqIFN1cHBvcnRzIGVudW1zIGZyb20ga2V5cyB0aGF0IGFyZSB2YWxpZCBKYXZhc2NyaXB0IGlkZW50aWZpZXJzIHRvIHVuaXF1ZSBpbnRlZ2VyIHZhbHVlc1xuICovXG5leHBvcnQgY2xhc3MgU2ltcGxlRW51bVR5cGU8RSBleHRlbmRzIG51bWJlcj4gaW1wbGVtZW50cyBWZXJzaW9uZWRUeXBlPEUsIGpzb24uSW5wdXQsIGpzb24uT3V0cHV0LCBEaWZmPiB7XG4gIHJlYWRvbmx5IG5hbWU6IE5hbWUgPSBuYW1lO1xuICByZWFkb25seSBlbnVtOiBFbnVtQ29uc3RydWN0b3I8RT47XG4gIHJlYWRvbmx5IHJlbmFtZT86IENhc2VTdHlsZTtcbiAgcmVhZG9ubHkgb3V0cHV0TmFtZVRvVmFsdWU6IEFueVNpbXBsZUVudW07XG4gIHJlYWRvbmx5IHZhbHVlVG9PdXRwdXROYW1lOiBBbnlSZXZlcnNlZEVudW07XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogTGF6eTxTaW1wbGVFbnVtVHlwZU9wdGlvbnM8RT4+O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IExhenk8U2ltcGxlRW51bVR5cGVPcHRpb25zPEU+Pikge1xuICAgIC8vIFRPRE86IFJlbW92ZSBvbmNlIFRTIDIuNyBpcyBiZXR0ZXIgc3VwcG9ydGVkIGJ5IGVkaXRvcnNcbiAgICB0aGlzLmVudW0gPSA8YW55PiB1bmRlZmluZWQ7XG4gICAgdGhpcy5vdXRwdXROYW1lVG9WYWx1ZSA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLnZhbHVlVG9PdXRwdXROYW1lID0gPGFueT4gdW5kZWZpbmVkO1xuXG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXp5UHJvcGVydGllcyh0aGlzLCB0aGlzLl9hcHBseU9wdGlvbnMsIFtcImVudW1cIiwgXCJyZW5hbWVcIiwgXCJvdXRwdXROYW1lVG9WYWx1ZVwiLCBcInZhbHVlVG9PdXRwdXROYW1lXCJdKTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgZnJvbUpTT04oKTogU2ltcGxlRW51bVR5cGU8YW55PiB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIlNpbXBsZUVudW1UeXBlLmZyb21KU09OXCIpO1xuICB9XG5cbiAgdG9KU09OKCk6IGpzb24uVHlwZSB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIlNpbXBsZUVudW1UeXBlI3RvSlNPTlwiKTtcbiAgfVxuXG4gIHJlYWRUcnVzdGVkSnNvbihpbnB1dDoganNvbi5PdXRwdXQpOiBFIHtcbiAgICByZXR1cm4gdGhpcy5vdXRwdXROYW1lVG9WYWx1ZVtpbnB1dF0gYXMgRTtcbiAgfVxuXG4gIHJlYWRKc29uKGlucHV0OiBhbnkpOiBFIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwic3RyaW5nXCIsIGlucHV0KTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm91dHB1dE5hbWVUb1ZhbHVlLmhhc093blByb3BlcnR5KGlucHV0KSkge1xuICAgICAgdGhyb3cgSW5jaWRlbnQoXCJVbmtub3duIGVudW0gdmFyaWFudCBuYW1lXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMub3V0cHV0TmFtZVRvVmFsdWVbaW5wdXRdIGFzIEU7XG4gIH1cblxuICB3cml0ZUpzb24odmFsOiBFKToganNvbi5PdXRwdXQge1xuICAgIHJldHVybiB0aGlzLnZhbHVlVG9PdXRwdXROYW1lW3ZhbCBhcyBudW1iZXJdO1xuICB9XG5cbiAgdGVzdEVycm9yKHZhbDogRSk6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudW1iZXJcIiwgdmFsKTtcbiAgICB9XG4gICAgLy8gVE9ETyhkZW11cmdvcyk6IFJlbW92ZSA8bnVtYmVyPiBvbmNlIHR5cGVkb2Mgc3VwcG9ydHMgaXRcbiAgICBpZiAoaXNOYU4odmFsKSB8fCB2YWwgPT09IEluZmluaXR5IHx8IHZhbCA9PT0gLUluZmluaXR5IHx8ICg8bnVtYmVyPiB2YWwgfCAwKSAhPT0gdmFsKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImludDMyXCIsIHZhbCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5lbnVtLmhhc093blByb3BlcnR5KHZhbCkpIHtcbiAgICAgIHJldHVybiBJbmNpZGVudChcIlVua25vd25WYXJpYW50RXJyb3JcIiwge3ZhbHVlOiB2YWx9LCBcIlVua25vd24gZW51bSB2YXJpYW50IHZhbHVlXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgdGVzdCh2YWw6IEUpOiB2YWwgaXMgRSB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWwgPT09IFwibnVtYmVyXCIgJiYgdGhpcy5lbnVtLmhhc093blByb3BlcnR5KHZhbCk7XG4gIH1cblxuICBlcXVhbHModmFsMTogRSwgdmFsMjogRSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2YWwxID09PSB2YWwyO1xuICB9XG5cbiAgY2xvbmUodmFsOiBFKTogRSB7XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIGRpZmYob2xkVmFsOiBFLCBuZXdWYWw6IEUpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gbmV3VmFsID09PSBvbGRWYWwgPyB1bmRlZmluZWQgOiA8bnVtYmVyPiBuZXdWYWwgLSA8bnVtYmVyPiBvbGRWYWw7XG4gIH1cblxuICBwYXRjaChvbGRWYWw6IEUsIGRpZmY6IERpZmYgfCB1bmRlZmluZWQpOiBFIHtcbiAgICByZXR1cm4gZGlmZiA9PT0gdW5kZWZpbmVkID8gb2xkVmFsIDogPG51bWJlcj4gb2xkVmFsICsgZGlmZiBhcyBFO1xuICB9XG5cbiAgcmV2ZXJzZURpZmYoZGlmZjogRGlmZiB8IHVuZGVmaW5lZCk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtYm9vbGVhbi1leHByZXNzaW9ucyAqL1xuICAgIHJldHVybiBkaWZmICYmIC1kaWZmO1xuICB9XG5cbiAgc3F1YXNoKGRpZmYxOiBEaWZmIHwgdW5kZWZpbmVkLCBkaWZmMjogRGlmZiB8IHVuZGVmaW5lZCk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIGlmIChkaWZmMSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gZGlmZjI7XG4gICAgfSBlbHNlIGlmIChkaWZmMiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gZGlmZjE7XG4gICAgfVxuICAgIHJldHVybiBkaWZmMiA9PT0gLWRpZmYxID8gdW5kZWZpbmVkIDogZGlmZjEgKyBkaWZmMjtcbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5T3B0aW9ucygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fb3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yKHRoaXMpO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zOiBTaW1wbGVFbnVtVHlwZU9wdGlvbnM8RT4gPSB0eXBlb2YgdGhpcy5fb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiID8gdGhpcy5fb3B0aW9ucygpIDogdGhpcy5fb3B0aW9ucztcblxuICAgIGNvbnN0IGJhc2VFbnVtOiBFbnVtQ29uc3RydWN0b3I8RT4gPSA8YW55PiBvcHRpb25zLmVudW07XG4gICAgY29uc3QgcmVuYW1lQWxsOiBDYXNlU3R5bGUgfCB1bmRlZmluZWQgPSBvcHRpb25zLnJlbmFtZTtcbiAgICBjb25zdCBvdXRwdXROYW1lVG9WYWx1ZTogQW55U2ltcGxlRW51bSA9IHt9O1xuICAgIGNvbnN0IHZhbHVlVG9PdXRwdXROYW1lOiBBbnlSZXZlcnNlZEVudW0gPSB7fTtcblxuICAgIGZvciAoY29uc3Qga2V5IGluIGJhc2VFbnVtKSB7XG4gICAgICBpZiAoL15cXGQrJC8udGVzdChrZXkpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdmFsdWU6IG51bWJlciA9ICg8e1tuYW1lOiBzdHJpbmddOiBudW1iZXJ9PiBvcHRpb25zLmVudW0pW2tleV07XG4gICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSBcIm51bWJlclwiKSB7XG4gICAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudW1iZXJcIiwgdmFsdWUpO1xuICAgICAgfVxuICAgICAgaWYgKCFiYXNlRW51bS5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSkgfHwgIWJhc2VFbnVtLmhhc093blByb3BlcnR5KHZhbHVlKSkge1xuICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJOb3RTaW1wbGVFbnVtXCIsIFwiTm90IG93bmVkIGtleSBvciB2YWx1ZVwiKTtcbiAgICAgIH1cbiAgICAgIGlmICgoPGFueT4gYmFzZUVudW1bdmFsdWVdIGFzIHN0cmluZykgIT09IGtleSkge1xuICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJOb3RSZXZlcnNpYmxlRW51bVwiLCBcImVudW1bZW51bVtrZXldXSAhPT0ga2V5XCIpO1xuICAgICAgfVxuICAgICAgbGV0IHJlbmFtZWQ6IHN0cmluZztcbiAgICAgIGlmIChyZW5hbWVBbGwgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZW5hbWVkID0ga2V5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVuYW1lZCA9IHJlbmFtZShrZXksIHJlbmFtZUFsbCk7XG4gICAgICB9XG4gICAgICBvdXRwdXROYW1lVG9WYWx1ZVtyZW5hbWVkXSA9IHZhbHVlO1xuICAgICAgdmFsdWVUb091dHB1dE5hbWVbdmFsdWVdID0gcmVuYW1lZDtcbiAgICB9XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtlbnVtOiBiYXNlRW51bSwgcmVuYW1lOiByZW5hbWVBbGwsIG91dHB1dE5hbWVUb1ZhbHVlLCB2YWx1ZVRvT3V0cHV0TmFtZX0pO1xuICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4ifQ==
