"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lazy_properties_1 = require("../_helpers/lazy-properties");
const invalid_array_items_1 = require("../errors/invalid-array-items");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
const max_array_length_1 = require("../errors/max-array-length");
const not_implemented_1 = require("../errors/not-implemented");
const json_1 = require("../json");
exports.name = "array";
// tslint:disable-next-line:variable-name
exports.ArrayType = class {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.itemType = undefined;
        this.maxLength = undefined;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["itemType", "maxLength"]);
        }
    }
    toJSON() {
        throw not_implemented_1.createNotImplementedError("ArrayType#toJSON");
    }
    readTrustedJson(input) {
        return input.map((item) => json_1.JSON_SERIALIZER.readTrusted(this.itemType, item));
    }
    readJson(input) {
        if (!Array.isArray(input)) {
            throw invalid_type_1.createInvalidTypeError("array", input);
        }
        if (this.maxLength !== undefined && input.length > this.maxLength) {
            throw max_array_length_1.createMaxArrayLengthError(input, this.maxLength);
        }
        let invalid = undefined;
        const result = [];
        const itemCount = input.length;
        for (let i = 0; i < itemCount; i++) {
            try {
                const item = json_1.JSON_SERIALIZER.read(this.itemType, input[i]);
                if (invalid === undefined) {
                    result.push(item);
                }
            }
            catch (err) {
                if (invalid === undefined) {
                    invalid = new Map();
                }
                invalid.set(i, err);
            }
        }
        if (invalid !== undefined) {
            throw invalid_array_items_1.createInvalidArrayItemsError(invalid);
        }
        return result;
    }
    writeJson(val) {
        return val.map((item) => json_1.JSON_SERIALIZER.write(this.itemType, item));
    }
    testError(val) {
        if (!Array.isArray(val)) {
            return invalid_type_1.createInvalidTypeError("array", val);
        }
        if (this.maxLength !== undefined && val.length > this.maxLength) {
            return max_array_length_1.createMaxArrayLengthError(val, this.maxLength);
        }
        const invalid = new Map();
        const itemCount = val.length;
        for (let i = 0; i < itemCount; i++) {
            const error = this.itemType.testError(val[i]);
            if (error !== undefined) {
                invalid.set(i, error);
            }
        }
        if (invalid.size !== 0) {
            return invalid_array_items_1.createInvalidArrayItemsError(invalid);
        }
        return undefined;
    }
    test(val) {
        if (!Array.isArray(val) || (this.maxLength !== undefined && val.length > this.maxLength)) {
            return false;
        }
        for (const item of val) {
            if (!this.itemType.test(item)) {
                return false;
            }
        }
        return true;
    }
    equals(val1, val2) {
        if (val2.length !== val1.length) {
            return false;
        }
        for (let i = 0; i < val1.length; i++) {
            if (!this.itemType.equals(val2[i], val1[i])) {
                return false;
            }
        }
        return true;
    }
    clone(val) {
        return val.map((item) => this.itemType.clone(item));
    }
    /**
     * @param oldVal
     * @param newVal
     * @returns `true` if there is a difference, `undefined` otherwise
     */
    diff(oldVal, newVal) {
        throw not_implemented_1.createNotImplementedError("ArrayType#diff");
    }
    patch(oldVal, diff) {
        throw not_implemented_1.createNotImplementedError("ArrayType#patch");
    }
    reverseDiff(diff) {
        throw not_implemented_1.createNotImplementedError("ArrayType#reverseDiff");
    }
    squash(diff1, diff2) {
        throw not_implemented_1.createNotImplementedError("ArrayType#squash");
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const itemType = options.itemType;
        const maxLength = options.maxLength;
        Object.assign(this, { itemType, maxLength });
        Object.freeze(this);
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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T0FBTyxDQUFDLFFBQVEsQ0FBQztRQUNuRSxNQUFNLFNBQVMsR0FBVyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBRTVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUMsUUFBUSxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUM7UUFDM0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0NBQ0YsQ0FBQyIsImZpbGUiOiJ0eXBlcy9hcnJheS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxhenlQcm9wZXJ0aWVzIH0gZnJvbSBcIi4uL19oZWxwZXJzL2xhenktcHJvcGVydGllc1wiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZEFycmF5SXRlbXNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC1hcnJheS1pdGVtc1wiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZFR5cGVFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC10eXBlXCI7XG5pbXBvcnQgeyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9sYXp5LW9wdGlvbnNcIjtcbmltcG9ydCB7IGNyZWF0ZU1heEFycmF5TGVuZ3RoRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL21heC1hcnJheS1sZW5ndGhcIjtcbmltcG9ydCB7IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL25vdC1pbXBsZW1lbnRlZFwiO1xuaW1wb3J0IHsgSlNPTl9TRVJJQUxJWkVSIH0gZnJvbSBcIi4uL2pzb25cIjtcbmltcG9ydCB7IExhenksIFZlcnNpb25lZFR5cGUgfSBmcm9tIFwiLi4vdHlwZXNcIjtcblxuZXhwb3J0IHR5cGUgTmFtZSA9IFwiYXJyYXlcIjtcbmV4cG9ydCBjb25zdCBuYW1lOiBOYW1lID0gXCJhcnJheVwiO1xuZXhwb3J0IG5hbWVzcGFjZSBqc29uIHtcbiAgLy8gVE9ETyhkZW11cmdvcyk6IEV4cG9ydCBhcnJheVR5cGUgdG8gSlNPTlxuICBleHBvcnQgdHlwZSBUeXBlID0gdW5kZWZpbmVkO1xufVxuZXhwb3J0IHR5cGUgRGlmZiA9IGFueTtcblxuZXhwb3J0IGludGVyZmFjZSBBcnJheVR5cGVPcHRpb25zPFQ+IHtcbiAgaXRlbVR5cGU6IFZlcnNpb25lZFR5cGU8VCwgYW55LCBhbnksIGFueT47XG4gIG1heExlbmd0aDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5VHlwZUNvbnN0cnVjdG9yIHtcbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBhcnJheSB0eXBlXG4gICAqL1xuICBuZXc8VD4ob3B0aW9uczogTGF6eTxBcnJheVR5cGVPcHRpb25zPFQ+Pik6IEFycmF5VHlwZTxUPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcnJheVR5cGU8VD4gZXh0ZW5kcyBWZXJzaW9uZWRUeXBlPFRbXSwgYW55LCBhbnksIERpZmY+LCBBcnJheVR5cGVPcHRpb25zPFQ+IHtcbn1cblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnZhcmlhYmxlLW5hbWVcbmV4cG9ydCBjb25zdCBBcnJheVR5cGU6IEFycmF5VHlwZUNvbnN0cnVjdG9yID0gY2xhc3M8VD4ge1xuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgaXRlbVR5cGU6IFZlcnNpb25lZFR5cGU8VCwgYW55LCBhbnksIGFueT47XG4gIHJlYWRvbmx5IG1heExlbmd0aDogbnVtYmVyO1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IExhenk8QXJyYXlUeXBlT3B0aW9uczxUPj47XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogTGF6eTxBcnJheVR5cGVPcHRpb25zPFQ+Pikge1xuICAgIC8vIFRPRE86IFJlbW92ZSBvbmNlIFRTIDIuNyBpcyBiZXR0ZXIgc3VwcG9ydGVkIGJ5IGVkaXRvcnNcbiAgICB0aGlzLml0ZW1UeXBlID0gPGFueT4gdW5kZWZpbmVkO1xuICAgIHRoaXMubWF4TGVuZ3RoID0gPGFueT4gdW5kZWZpbmVkO1xuXG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXp5UHJvcGVydGllcyh0aGlzLCB0aGlzLl9hcHBseU9wdGlvbnMsIFtcIml0ZW1UeXBlXCIsIFwibWF4TGVuZ3RoXCJdKTtcbiAgICB9XG4gIH1cblxuICB0b0pTT04oKToganNvbi5UeXBlIHtcbiAgICB0aHJvdyBjcmVhdGVOb3RJbXBsZW1lbnRlZEVycm9yKFwiQXJyYXlUeXBlI3RvSlNPTlwiKTtcbiAgfVxuXG4gIHJlYWRUcnVzdGVkSnNvbihpbnB1dDogYW55W10pOiBUW10ge1xuICAgIHJldHVybiBpbnB1dC5tYXAoKGl0ZW06IGFueSk6IFQgPT4gSlNPTl9TRVJJQUxJWkVSLnJlYWRUcnVzdGVkKHRoaXMuaXRlbVR5cGUsIGl0ZW0pKTtcbiAgfVxuXG4gIHJlYWRKc29uKGlucHV0OiBhbnkpOiBUW10ge1xuICAgIGlmICghQXJyYXkuaXNBcnJheShpbnB1dCkpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJhcnJheVwiLCBpbnB1dCk7XG4gICAgfVxuICAgIGlmICh0aGlzLm1heExlbmd0aCAhPT0gdW5kZWZpbmVkICYmIGlucHV0Lmxlbmd0aCA+IHRoaXMubWF4TGVuZ3RoKSB7XG4gICAgICB0aHJvdyBjcmVhdGVNYXhBcnJheUxlbmd0aEVycm9yKGlucHV0LCB0aGlzLm1heExlbmd0aCk7XG4gICAgfVxuICAgIGxldCBpbnZhbGlkOiB1bmRlZmluZWQgfCBNYXA8bnVtYmVyLCBFcnJvcj4gPSB1bmRlZmluZWQ7XG4gICAgY29uc3QgcmVzdWx0OiBUW10gPSBbXTtcbiAgICBjb25zdCBpdGVtQ291bnQ6IG51bWJlciA9IGlucHV0Lmxlbmd0aDtcbiAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgaXRlbUNvdW50OyBpKyspIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGl0ZW06IFQgPSBKU09OX1NFUklBTElaRVIucmVhZCh0aGlzLml0ZW1UeXBlLCBpbnB1dFtpXSk7XG4gICAgICAgIGlmIChpbnZhbGlkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmIChpbnZhbGlkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBpbnZhbGlkID0gbmV3IE1hcCgpO1xuICAgICAgICB9XG4gICAgICAgIGludmFsaWQuc2V0KGksIGVycik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChpbnZhbGlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRBcnJheUl0ZW1zRXJyb3IoaW52YWxpZCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICB3cml0ZUpzb24odmFsOiBUW10pOiBhbnlbXSB7XG4gICAgcmV0dXJuIHZhbC5tYXAoKGl0ZW06IFQpOiBhbnkgPT4gSlNPTl9TRVJJQUxJWkVSLndyaXRlKHRoaXMuaXRlbVR5cGUsIGl0ZW0pKTtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IFRbXSk6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJhcnJheVwiLCB2YWwpO1xuICAgIH1cbiAgICBpZiAodGhpcy5tYXhMZW5ndGggIT09IHVuZGVmaW5lZCAmJiB2YWwubGVuZ3RoID4gdGhpcy5tYXhMZW5ndGgpIHtcbiAgICAgIHJldHVybiBjcmVhdGVNYXhBcnJheUxlbmd0aEVycm9yKHZhbCwgdGhpcy5tYXhMZW5ndGgpO1xuICAgIH1cbiAgICBjb25zdCBpbnZhbGlkOiBNYXA8bnVtYmVyLCBFcnJvcj4gPSBuZXcgTWFwKCk7XG4gICAgY29uc3QgaXRlbUNvdW50OiBudW1iZXIgPSB2YWwubGVuZ3RoO1xuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBpdGVtQ291bnQ7IGkrKykge1xuICAgICAgY29uc3QgZXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkID0gdGhpcy5pdGVtVHlwZS50ZXN0RXJyb3IodmFsW2ldKTtcbiAgICAgIGlmIChlcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGludmFsaWQuc2V0KGksIGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGludmFsaWQuc2l6ZSAhPT0gMCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRBcnJheUl0ZW1zRXJyb3IoaW52YWxpZCk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogVFtdKTogdmFsIGlzIFRbXSB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbCkgfHwgKHRoaXMubWF4TGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgdmFsLmxlbmd0aCA+IHRoaXMubWF4TGVuZ3RoKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsKSB7XG4gICAgICBpZiAoIXRoaXMuaXRlbVR5cGUudGVzdChpdGVtKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZXF1YWxzKHZhbDE6IFRbXSwgdmFsMjogVFtdKTogYm9vbGVhbiB7XG4gICAgaWYgKHZhbDIubGVuZ3RoICE9PSB2YWwxLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgdmFsMS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKCF0aGlzLml0ZW1UeXBlLmVxdWFscyh2YWwyW2ldLCB2YWwxW2ldKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY2xvbmUodmFsOiBUW10pOiBUW10ge1xuICAgIHJldHVybiB2YWwubWFwKChpdGVtOiBUKTogVCA9PiB0aGlzLml0ZW1UeXBlLmNsb25lKGl0ZW0pKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0gb2xkVmFsXG4gICAqIEBwYXJhbSBuZXdWYWxcbiAgICogQHJldHVybnMgYHRydWVgIGlmIHRoZXJlIGlzIGEgZGlmZmVyZW5jZSwgYHVuZGVmaW5lZGAgb3RoZXJ3aXNlXG4gICAqL1xuICBkaWZmKG9sZFZhbDogVFtdLCBuZXdWYWw6IFRbXSk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJBcnJheVR5cGUjZGlmZlwiKTtcbiAgfVxuXG4gIHBhdGNoKG9sZFZhbDogVFtdLCBkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogVFtdIHtcbiAgICB0aHJvdyBjcmVhdGVOb3RJbXBsZW1lbnRlZEVycm9yKFwiQXJyYXlUeXBlI3BhdGNoXCIpO1xuICB9XG5cbiAgcmV2ZXJzZURpZmYoZGlmZjogRGlmZiB8IHVuZGVmaW5lZCk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJBcnJheVR5cGUjcmV2ZXJzZURpZmZcIik7XG4gIH1cblxuICBzcXVhc2goZGlmZjE6IERpZmYgfCB1bmRlZmluZWQsIGRpZmYyOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIkFycmF5VHlwZSNzcXVhc2hcIik7XG4gIH1cblxuICBwcml2YXRlIF9hcHBseU9wdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY3JlYXRlTGF6eU9wdGlvbnNFcnJvcih0aGlzKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9uczogQXJyYXlUeXBlT3B0aW9uczxUPiA9IHR5cGVvZiB0aGlzLl9vcHRpb25zID09PSBcImZ1bmN0aW9uXCIgPyB0aGlzLl9vcHRpb25zKCkgOiB0aGlzLl9vcHRpb25zO1xuXG4gICAgY29uc3QgaXRlbVR5cGU6IFZlcnNpb25lZFR5cGU8VCwgYW55LCBhbnksIGFueT4gPSBvcHRpb25zLml0ZW1UeXBlO1xuICAgIGNvbnN0IG1heExlbmd0aDogbnVtYmVyID0gb3B0aW9ucy5tYXhMZW5ndGg7XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtpdGVtVHlwZSwgbWF4TGVuZ3RofSk7XG4gICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgfVxufTtcbiJdLCJzb3VyY2VSb290IjoiLi4ifQ==
