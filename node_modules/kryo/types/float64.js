"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lazy_properties_1 = require("../_helpers/lazy-properties");
const invalid_float64_1 = require("../errors/invalid-float64");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
exports.name = "float64";
// tslint:disable:max-line-length
class Float64Type {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.allowNaN = undefined;
        this.allowInfinity = undefined;
        this._options = options !== undefined ? options : {};
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["allowNaN", "allowInfinity"]);
        }
    }
    static fromJSON(options) {
        return new Float64Type(options);
    }
    toJSON() {
        return {
            name: exports.name,
            allowNaN: this.allowNaN,
            allowInfinity: this.allowInfinity,
        };
    }
    readTrustedJson(input) {
        switch (input) {
            case "NaN":
                return NaN;
            case "+Infinity":
                return Infinity;
            case "-Infinity":
                return -Infinity;
            default:
                return input;
        }
    }
    readJson(input) {
        switch (input) {
            case "NaN":
                if (!this.allowNaN) {
                    throw invalid_float64_1.createInvalidFloat64Error(input);
                }
                return NaN;
            case "+Infinity":
                if (!this.allowInfinity) {
                    throw invalid_float64_1.createInvalidFloat64Error(input);
                }
                return Infinity;
            case "-Infinity":
                if (!this.allowInfinity) {
                    throw invalid_float64_1.createInvalidFloat64Error(input);
                }
                return -Infinity;
            default:
                if (typeof input === "number") {
                    return input;
                }
                else {
                    throw invalid_float64_1.createInvalidFloat64Error(input);
                }
        }
    }
    writeJson(val) {
        if (isNaN(val)) {
            return "NaN";
        }
        else if (val === Infinity) {
            return "+Infinity";
        }
        else if (val === -Infinity) {
            return "-Infinity";
        }
        return val;
    }
    testError(val) {
        if (typeof val !== "number") {
            return invalid_type_1.createInvalidTypeError("number", val);
        }
        if (isNaN(val) && !this.allowNaN) {
            return invalid_float64_1.createInvalidFloat64Error(val);
        }
        else if (Math.abs(val) === Infinity && !this.allowInfinity) {
            return invalid_float64_1.createInvalidFloat64Error(val);
        }
        return undefined;
    }
    test(val) {
        return typeof val === "number" && (this.allowNaN || !isNaN(val)) && (this.allowInfinity || Math.abs(val) !== Infinity);
    }
    equals(val1, val2) {
        if (isNaN(val1) || isNaN(val2)) {
            return isNaN(val1) && isNaN(val2);
        }
        return val1 === val2;
    }
    clone(val) {
        return val;
    }
    diff(oldVal, newVal) {
        // We can't use an arithmetic difference due to possible precision loss
        return this.equals(oldVal, newVal) ? undefined : [oldVal, newVal];
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : diff[1];
    }
    reverseDiff(diff) {
        return diff === undefined ? undefined : [diff[1], diff[0]];
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2 === undefined ? undefined : [diff2[0], diff2[1]];
        }
        else if (diff2 === undefined) {
            return [diff1[0], diff1[1]];
        }
        return this.equals(diff1[0], diff2[1]) ? undefined : [diff1[0], diff2[1]];
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const allowNaN = options.allowNaN !== undefined ? options.allowNaN : false;
        const allowInfinity = options.allowInfinity !== undefined ? options.allowInfinity : false;
        Object.assign(this, { allowNaN, allowInfinity });
        Object.freeze(this);
    }
}
exports.Float64Type = Float64Type;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUVuRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFDLFFBQVEsRUFBRSxhQUFhLEVBQUMsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBOUlELGtDQThJQyIsImZpbGUiOiJ0eXBlcy9mbG9hdDY0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5jaWRlbnQgfSBmcm9tIFwiaW5jaWRlbnRcIjtcbmltcG9ydCB7IGxhenlQcm9wZXJ0aWVzIH0gZnJvbSBcIi4uL19oZWxwZXJzL2xhenktcHJvcGVydGllc1wiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZEZsb2F0NjRFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC1mbG9hdDY0XCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLXR5cGVcIjtcbmltcG9ydCB7IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2xhenktb3B0aW9uc1wiO1xuaW1wb3J0IHsgTGF6eSwgVmVyc2lvbmVkVHlwZSB9IGZyb20gXCIuLi90eXBlc1wiO1xuXG5leHBvcnQgdHlwZSBOYW1lID0gXCJmbG9hdDY0XCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwiZmxvYXQ2NFwiO1xuZXhwb3J0IG5hbWVzcGFjZSBqc29uIHtcbiAgZXhwb3J0IGludGVyZmFjZSBUeXBlIHtcbiAgICByZWFkb25seSBuYW1lOiBOYW1lO1xuICAgIHJlYWRvbmx5IGFsbG93TmFOOiBib29sZWFuO1xuICAgIHJlYWRvbmx5IGFsbG93SW5maW5pdHk6IGJvb2xlYW47XG4gIH1cbn1cbmV4cG9ydCB0eXBlIERpZmYgPSBbbnVtYmVyLCBudW1iZXJdO1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHRoZSBgRmxvYXQ2NGAgbWV0YS10eXBlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEZsb2F0NjRUeXBlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBBY2NlcHQgYE5hTmAgdmFsdWVzLlxuICAgKiBJZiB5b3UgZW5hYmxlIHRoaXMgb3B0aW9uLCB0aGUgYHRlc3RgIG1ldGhvZCB3aWxsIHRyZWF0IHR3byBgTmFOYCB2YWx1ZXMgYXMgZXF1YWwuXG4gICAqXG4gICAqIEBkZWZhdWx0IGBmYWxzZWBcbiAgICovXG4gIHJlYWRvbmx5IGFsbG93TmFOPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQWNjZXB0IGArSW5maW5pdHlgIGFuZCBgLUluZmluaXR5YC5cbiAgICpcbiAgICogQGRlZmF1bHQgYGZhbHNlYFxuICAgKi9cbiAgcmVhZG9ubHkgYWxsb3dJbmZpbml0eT86IGJvb2xlYW47XG5cbiAgLy8gVE9ETzogQWRkIGB1bmlmeVplcm9zYCAoZGVmYXVsdHMgdG8gYHRydWVgKSB0byBoYW5kbGUgYCswYCBhbmQgYC0wYFxufVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZTptYXgtbGluZS1sZW5ndGhcbmV4cG9ydCBjbGFzcyBGbG9hdDY0VHlwZSBpbXBsZW1lbnRzIFZlcnNpb25lZFR5cGU8bnVtYmVyLCBudW1iZXIgfCBcIk5hTlwiIHwgXCIrSW5maW5pdHlcIiB8IFwiLUluZmluaXR5XCIsIG51bWJlciB8IFwiTmFOXCIgfCBcIitJbmZpbml0eVwiIHwgXCItSW5maW5pdHlcIiwgRGlmZj4ge1xuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgYWxsb3dOYU46IGJvb2xlYW47XG4gIHJlYWRvbmx5IGFsbG93SW5maW5pdHk6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogTGF6eTxGbG9hdDY0VHlwZU9wdGlvbnM+O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBMYXp5PEZsb2F0NjRUeXBlT3B0aW9ucz4pIHtcbiAgICAvLyBUT0RPOiBSZW1vdmUgb25jZSBUUyAyLjcgaXMgYmV0dGVyIHN1cHBvcnRlZCBieSBlZGl0b3JzXG4gICAgdGhpcy5hbGxvd05hTiA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLmFsbG93SW5maW5pdHkgPSA8YW55PiB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucyA6IHt9O1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXModGhpcywgdGhpcy5fYXBwbHlPcHRpb25zLCBbXCJhbGxvd05hTlwiLCBcImFsbG93SW5maW5pdHlcIl0pO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBmcm9tSlNPTihvcHRpb25zOiBqc29uLlR5cGUpOiBGbG9hdDY0VHlwZSB7XG4gICAgcmV0dXJuIG5ldyBGbG9hdDY0VHlwZShvcHRpb25zKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBqc29uLlR5cGUge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgYWxsb3dOYU46IHRoaXMuYWxsb3dOYU4sXG4gICAgICBhbGxvd0luZmluaXR5OiB0aGlzLmFsbG93SW5maW5pdHksXG4gICAgfTtcbiAgfVxuXG4gIHJlYWRUcnVzdGVkSnNvbihpbnB1dDogbnVtYmVyIHwgXCJOYU5cIiB8IFwiK0luZmluaXR5XCIgfCBcIi1JbmZpbml0eVwiKTogbnVtYmVyIHtcbiAgICBzd2l0Y2ggKGlucHV0KSB7XG4gICAgICBjYXNlIFwiTmFOXCI6XG4gICAgICAgIHJldHVybiBOYU47XG4gICAgICBjYXNlIFwiK0luZmluaXR5XCI6XG4gICAgICAgIHJldHVybiBJbmZpbml0eTtcbiAgICAgIGNhc2UgXCItSW5maW5pdHlcIjpcbiAgICAgICAgcmV0dXJuIC1JbmZpbml0eTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBpbnB1dDtcbiAgICB9XG4gIH1cblxuICByZWFkSnNvbihpbnB1dDogbnVtYmVyIHwgXCJOYU5cIiB8IFwiK0luZmluaXR5XCIgfCBcIi1JbmZpbml0eVwiKTogbnVtYmVyIHtcbiAgICBzd2l0Y2ggKGlucHV0KSB7XG4gICAgICBjYXNlIFwiTmFOXCI6XG4gICAgICAgIGlmICghdGhpcy5hbGxvd05hTikge1xuICAgICAgICAgIHRocm93IGNyZWF0ZUludmFsaWRGbG9hdDY0RXJyb3IoaW5wdXQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBOYU47XG4gICAgICBjYXNlIFwiK0luZmluaXR5XCI6XG4gICAgICAgIGlmICghdGhpcy5hbGxvd0luZmluaXR5KSB7XG4gICAgICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZEZsb2F0NjRFcnJvcihpbnB1dCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEluZmluaXR5O1xuICAgICAgY2FzZSBcIi1JbmZpbml0eVwiOlxuICAgICAgICBpZiAoIXRoaXMuYWxsb3dJbmZpbml0eSkge1xuICAgICAgICAgIHRocm93IGNyZWF0ZUludmFsaWRGbG9hdDY0RXJyb3IoaW5wdXQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAtSW5maW5pdHk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgcmV0dXJuIGlucHV0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGNyZWF0ZUludmFsaWRGbG9hdDY0RXJyb3IoaW5wdXQpO1xuICAgICAgICB9XG4gICAgfVxuICB9XG5cbiAgd3JpdGVKc29uKHZhbDogbnVtYmVyKTogbnVtYmVyIHwgXCJOYU5cIiB8IFwiK0luZmluaXR5XCIgfCBcIi1JbmZpbml0eVwiIHtcbiAgICBpZiAoaXNOYU4odmFsKSkge1xuICAgICAgcmV0dXJuIFwiTmFOXCI7XG4gICAgfSBlbHNlIGlmICh2YWwgPT09IEluZmluaXR5KSB7XG4gICAgICByZXR1cm4gXCIrSW5maW5pdHlcIjtcbiAgICB9IGVsc2UgaWYgKHZhbCA9PT0gLUluZmluaXR5KSB7XG4gICAgICByZXR1cm4gXCItSW5maW5pdHlcIjtcbiAgICB9XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IG51bWJlcik6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudW1iZXJcIiwgdmFsKTtcbiAgICB9XG4gICAgaWYgKGlzTmFOKHZhbCkgJiYgIXRoaXMuYWxsb3dOYU4pIHtcbiAgICAgIHJldHVybiBjcmVhdGVJbnZhbGlkRmxvYXQ2NEVycm9yKHZhbCk7XG4gICAgfSBlbHNlIGlmIChNYXRoLmFicyh2YWwpID09PSBJbmZpbml0eSAmJiAhdGhpcy5hbGxvd0luZmluaXR5KSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZEZsb2F0NjRFcnJvcih2YWwpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgdGVzdCh2YWw6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0eXBlb2YgdmFsID09PSBcIm51bWJlclwiICYmICh0aGlzLmFsbG93TmFOIHx8ICFpc05hTih2YWwpKSAmJiAodGhpcy5hbGxvd0luZmluaXR5IHx8IE1hdGguYWJzKHZhbCkgIT09IEluZmluaXR5KTtcbiAgfVxuXG4gIGVxdWFscyh2YWwxOiBudW1iZXIsIHZhbDI6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGlmIChpc05hTih2YWwxKSB8fCBpc05hTih2YWwyKSkge1xuICAgICAgcmV0dXJuIGlzTmFOKHZhbDEpICYmIGlzTmFOKHZhbDIpO1xuICAgIH1cbiAgICByZXR1cm4gdmFsMSA9PT0gdmFsMjtcbiAgfVxuXG4gIGNsb25lKHZhbDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgZGlmZihvbGRWYWw6IG51bWJlciwgbmV3VmFsOiBudW1iZXIpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBXZSBjYW4ndCB1c2UgYW4gYXJpdGhtZXRpYyBkaWZmZXJlbmNlIGR1ZSB0byBwb3NzaWJsZSBwcmVjaXNpb24gbG9zc1xuICAgIHJldHVybiB0aGlzLmVxdWFscyhvbGRWYWwsIG5ld1ZhbCkgPyB1bmRlZmluZWQgOiBbb2xkVmFsLCBuZXdWYWxdO1xuICB9XG5cbiAgcGF0Y2gob2xkVmFsOiBudW1iZXIsIGRpZmY6IERpZmYgfCB1bmRlZmluZWQpOiBudW1iZXIge1xuICAgIHJldHVybiBkaWZmID09PSB1bmRlZmluZWQgPyBvbGRWYWwgOiBkaWZmWzFdO1xuICB9XG5cbiAgcmV2ZXJzZURpZmYoZGlmZjogRGlmZiB8IHVuZGVmaW5lZCk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiBkaWZmID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBbZGlmZlsxXSwgZGlmZlswXV07XG4gIH1cblxuICBzcXVhc2goZGlmZjE6IERpZmYgfCB1bmRlZmluZWQsIGRpZmYyOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKGRpZmYxID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBkaWZmMiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogW2RpZmYyWzBdLCBkaWZmMlsxXV07XG4gICAgfSBlbHNlIGlmIChkaWZmMiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gW2RpZmYxWzBdLCBkaWZmMVsxXV07XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmVxdWFscyhkaWZmMVswXSwgZGlmZjJbMV0pID8gdW5kZWZpbmVkIDogW2RpZmYxWzBdLCBkaWZmMlsxXV07XG4gIH1cblxuICBwcml2YXRlIF9hcHBseU9wdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY3JlYXRlTGF6eU9wdGlvbnNFcnJvcih0aGlzKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9uczogRmxvYXQ2NFR5cGVPcHRpb25zID0gdHlwZW9mIHRoaXMuX29wdGlvbnMgPT09IFwiZnVuY3Rpb25cIiA/IHRoaXMuX29wdGlvbnMoKSA6IHRoaXMuX29wdGlvbnM7XG4gICAgY29uc3QgYWxsb3dOYU46IGJvb2xlYW4gPSBvcHRpb25zLmFsbG93TmFOICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmFsbG93TmFOIDogZmFsc2U7XG4gICAgY29uc3QgYWxsb3dJbmZpbml0eTogYm9vbGVhbiA9IG9wdGlvbnMuYWxsb3dJbmZpbml0eSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5hbGxvd0luZmluaXR5IDogZmFsc2U7XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHthbGxvd05hTiwgYWxsb3dJbmZpbml0eX0pO1xuICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4ifQ==
