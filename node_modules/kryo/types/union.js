"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const lazy_properties_1 = require("../_helpers/lazy-properties");
const lazy_options_1 = require("../errors/lazy-options");
const not_implemented_1 = require("../errors/not-implemented");
const index_1 = require("../json/index");
exports.name = "union";
class UnionType {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.variants = undefined;
        this.matcher = undefined;
        this.trustedMatcher = undefined;
        this.readMatcher = undefined;
        this.readTrustedMatcher = undefined;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["variants", "matcher", "trustedMatcher", "readMatcher", "readTrustedMatcher"]);
        }
    }
    toJSON() {
        throw not_implemented_1.createNotImplementedError("UnionType#toJSON");
    }
    readTrustedJsonWithVariant(input) {
        const variant = this.readTrustedMatcher(input, index_1.JSON_SERIALIZER);
        // TODO(demurgos): Avoid casting
        return [variant.readTrustedJson(input), variant];
    }
    readJsonWithVariant(input) {
        const variant = this.readMatcher(input, index_1.JSON_SERIALIZER);
        if (variant === undefined) {
            throw new incident_1.Incident("UnknownUnionVariant", "Unknown union variant");
        }
        // TODO(demurgos): Avoid casting
        return [variant.readJson(input), variant];
    }
    readTrustedJson(input) {
        return this.readTrustedJsonWithVariant(input)[0];
    }
    readJson(input) {
        return this.readJsonWithVariant(input)[0];
    }
    writeJson(val) {
        // TODO(demurgos): Avoid casting
        return this.trustedMatcher(val).writeJson(val);
    }
    testError(val) {
        const type = this.matcher(val);
        if (type === undefined) {
            return new incident_1.Incident("UnknownUnionVariant", "Unknown union variant");
        }
        return type.testError(val);
    }
    testWithVariant(val) {
        const variant = this.matcher(val);
        if (variant === undefined) {
            return [false, undefined];
        }
        return [variant.test(val), variant];
    }
    test(val) {
        const type = this.matcher(val);
        if (type === undefined) {
            return false;
        }
        return type.test(val);
    }
    // TODO: Always return true?
    equals(val1, val2) {
        const type1 = this.trustedMatcher(val1);
        const type2 = this.trustedMatcher(val2);
        return type1 === type2 && type1.equals(val1, val2);
    }
    clone(val) {
        return this.trustedMatcher(val).clone(val);
    }
    diff(oldVal, newVal) {
        throw not_implemented_1.createNotImplementedError("UnionType#diff");
    }
    patch(oldVal, diff) {
        throw not_implemented_1.createNotImplementedError("UnionType#patch");
    }
    reverseDiff(diff) {
        throw not_implemented_1.createNotImplementedError("UnionType#reverseDiff");
    }
    squash(diff1, diff2) {
        throw not_implemented_1.createNotImplementedError("UnionType#squash");
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function"
            ? this._options()
            : this._options;
        delete this._options;
        const variants = options.variants;
        const matcher = options.matcher;
        let trustedMatcher;
        if (options.trustedMatcher !== undefined) {
            trustedMatcher = options.trustedMatcher;
        }
        else {
            trustedMatcher = (value) => {
                const variant = matcher(value);
                if (variant === undefined) {
                    throw new incident_1.Incident("UnknownUnionVariant", "Unknown union variant");
                }
                return variant;
            };
        }
        const readMatcher = options.readMatcher;
        let readTrustedMatcher;
        if (options.readTrustedMatcher !== undefined) {
            readTrustedMatcher = options.readTrustedMatcher;
        }
        else {
            readTrustedMatcher = (input, serializer) => {
                const variant = readMatcher(input, serializer);
                if (variant === undefined) {
                    throw new incident_1.Incident("UnknownUnionVariant", { input, serializer }, "Unknown union variant");
                }
                return variant;
            };
        }
        Object.assign(this, { variants, matcher, trustedMatcher, readMatcher, readTrustedMatcher });
        Object.freeze(this);
    }
}
exports.UnionType = UnionType;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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XCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgbGF6eVByb3BlcnRpZXMgfSBmcm9tIFwiLi4vX2hlbHBlcnMvbGF6eS1wcm9wZXJ0aWVzXCI7XG5pbXBvcnQgeyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9sYXp5LW9wdGlvbnNcIjtcbmltcG9ydCB7IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IsIE5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL25vdC1pbXBsZW1lbnRlZFwiO1xuaW1wb3J0IHsgSlNPTl9TRVJJQUxJWkVSIH0gZnJvbSBcIi4uL2pzb24vaW5kZXhcIjtcbmltcG9ydCB7IEpzb25TZXJpYWxpemVyLCBMYXp5LCBTZXJpYWxpemVyLCBUeXBlLCBWZXJzaW9uZWRUeXBlIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcInVuaW9uXCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwidW5pb25cIjtcbmV4cG9ydCBuYW1lc3BhY2UganNvbiB7XG4gIGV4cG9ydCB0eXBlIElucHV0ID0gYW55O1xuICBleHBvcnQgdHlwZSBPdXRwdXQgPSBhbnk7XG4gIGV4cG9ydCB0eXBlIFR5cGUgPSB1bmRlZmluZWQ7XG59XG5leHBvcnQgdHlwZSBEaWZmID0gYW55O1xuXG5leHBvcnQgdHlwZSBNYXRjaGVyPFQ+ID0gKHZhbHVlOiBUKSA9PiBUeXBlPFQ+IHwgdW5kZWZpbmVkO1xuZXhwb3J0IHR5cGUgVHJ1c3RlZE1hdGNoZXI8VD4gPSAodmFsdWU6IFQpID0+IFR5cGU8VD47XG5leHBvcnQgdHlwZSBSZWFkTWF0Y2hlcjxUPiA9IChpbnB1dDogYW55LCBzZXJpYWxpemVyOiBTZXJpYWxpemVyKSA9PiBUeXBlPFQ+IHwgdW5kZWZpbmVkO1xuZXhwb3J0IHR5cGUgUmVhZFRydXN0ZWRNYXRjaGVyPFQ+ID0gKGlucHV0OiBhbnksIHNlcmlhbGl6ZXI6IFNlcmlhbGl6ZXIpID0+IFR5cGU8VD47XG5cbmV4cG9ydCBpbnRlcmZhY2UgVW5pb25UeXBlT3B0aW9uczxULCBPdXRwdXQsIElucHV0IGV4dGVuZHMgT3V0cHV0LCBEaWZmPiB7XG4gIHZhcmlhbnRzOiBWZXJzaW9uZWRUeXBlPFQsIE91dHB1dCwgSW5wdXQsIERpZmY+W107XG4gIG1hdGNoZXI6IE1hdGNoZXI8VD47XG4gIHRydXN0ZWRNYXRjaGVyPzogVHJ1c3RlZE1hdGNoZXI8VD47XG4gIHJlYWRNYXRjaGVyOiBSZWFkTWF0Y2hlcjxUPjtcbiAgcmVhZFRydXN0ZWRNYXRjaGVyPzogUmVhZFRydXN0ZWRNYXRjaGVyPFQ+O1xufVxuXG4vKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoICovXG5leHBvcnQgdHlwZSBUZXN0V2l0aFZhcmlhbnRSZXN1bHQ8VD4gPVxuICBbdHJ1ZSwgVmVyc2lvbmVkVHlwZTxULCBhbnksIGFueSwgYW55Pl1cbiAgfCBbZmFsc2UsIFZlcnNpb25lZFR5cGU8VCwgYW55LCBhbnksIGFueT4gfCB1bmRlZmluZWRdO1xuXG5leHBvcnQgY2xhc3MgVW5pb25UeXBlPFQ+IGltcGxlbWVudHMgVmVyc2lvbmVkVHlwZTxULCBqc29uLklucHV0LCBqc29uLk91dHB1dCwgRGlmZj4ge1xuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgdmFyaWFudHM6IFZlcnNpb25lZFR5cGU8VCwgYW55LCBhbnksIERpZmY+W107XG4gIHJlYWRvbmx5IG1hdGNoZXI6IE1hdGNoZXI8VD47XG4gIHJlYWRvbmx5IHRydXN0ZWRNYXRjaGVyOiBUcnVzdGVkTWF0Y2hlcjxUPjtcbiAgcmVhZG9ubHkgcmVhZE1hdGNoZXI6IFJlYWRNYXRjaGVyPFQ+O1xuICByZWFkb25seSByZWFkVHJ1c3RlZE1hdGNoZXI6IFJlYWRUcnVzdGVkTWF0Y2hlcjxUPjtcblxuICBwcml2YXRlIF9vcHRpb25zPzogTGF6eTxVbmlvblR5cGVPcHRpb25zPFQsIGFueSwgYW55LCBhbnk+PjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBMYXp5PFVuaW9uVHlwZU9wdGlvbnM8VCwgYW55LCBhbnksIGFueT4+KSB7XG4gICAgLy8gVE9ETzogUmVtb3ZlIG9uY2UgVFMgMi43IGlzIGJldHRlciBzdXBwb3J0ZWQgYnkgZWRpdG9yc1xuICAgIHRoaXMudmFyaWFudHMgPSA8YW55PiB1bmRlZmluZWQ7XG4gICAgdGhpcy5tYXRjaGVyID0gPGFueT4gdW5kZWZpbmVkO1xuICAgIHRoaXMudHJ1c3RlZE1hdGNoZXIgPSA8YW55PiB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZWFkTWF0Y2hlciA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlYWRUcnVzdGVkTWF0Y2hlciA9IDxhbnk+IHVuZGVmaW5lZDtcblxuICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXMoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucyxcbiAgICAgICAgW1widmFyaWFudHNcIiwgXCJtYXRjaGVyXCIsIFwidHJ1c3RlZE1hdGNoZXJcIiwgXCJyZWFkTWF0Y2hlclwiLCBcInJlYWRUcnVzdGVkTWF0Y2hlclwiXSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgdG9KU09OKCk6IGpzb24uVHlwZSB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIlVuaW9uVHlwZSN0b0pTT05cIik7XG4gIH1cblxuICByZWFkVHJ1c3RlZEpzb25XaXRoVmFyaWFudChpbnB1dDoganNvbi5PdXRwdXQpOiBbVCwgVHlwZTxUPl0ge1xuICAgIGNvbnN0IHZhcmlhbnQ6IFR5cGU8VD4gPSB0aGlzLnJlYWRUcnVzdGVkTWF0Y2hlcihpbnB1dCwgSlNPTl9TRVJJQUxJWkVSKTtcbiAgICAvLyBUT0RPKGRlbXVyZ29zKTogQXZvaWQgY2FzdGluZ1xuICAgIHJldHVybiBbKDxhbnk+IHZhcmlhbnQgYXMgSnNvblNlcmlhbGl6ZXI8VD4pLnJlYWRUcnVzdGVkSnNvbihpbnB1dCksIHZhcmlhbnRdO1xuICB9XG5cbiAgcmVhZEpzb25XaXRoVmFyaWFudChpbnB1dDogYW55KTogW1QsIFR5cGU8VD5dIHtcbiAgICBjb25zdCB2YXJpYW50OiBUeXBlPFQ+IHwgdW5kZWZpbmVkID0gdGhpcy5yZWFkTWF0Y2hlcihpbnB1dCwgSlNPTl9TRVJJQUxJWkVSKTtcbiAgICBpZiAodmFyaWFudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJVbmtub3duVW5pb25WYXJpYW50XCIsIFwiVW5rbm93biB1bmlvbiB2YXJpYW50XCIpO1xuICAgIH1cbiAgICAvLyBUT0RPKGRlbXVyZ29zKTogQXZvaWQgY2FzdGluZ1xuICAgIHJldHVybiBbKDxhbnk+IHZhcmlhbnQgYXMgSnNvblNlcmlhbGl6ZXI8VD4pLnJlYWRKc29uKGlucHV0KSwgdmFyaWFudF07XG4gIH1cblxuICByZWFkVHJ1c3RlZEpzb24oaW5wdXQ6IGpzb24uT3V0cHV0KTogVCB7XG4gICAgcmV0dXJuIHRoaXMucmVhZFRydXN0ZWRKc29uV2l0aFZhcmlhbnQoaW5wdXQpWzBdO1xuICB9XG5cbiAgcmVhZEpzb24oaW5wdXQ6IGFueSk6IFQge1xuICAgIHJldHVybiB0aGlzLnJlYWRKc29uV2l0aFZhcmlhbnQoaW5wdXQpWzBdO1xuICB9XG5cbiAgd3JpdGVKc29uKHZhbDogVCk6IGpzb24uT3V0cHV0IHtcbiAgICAvLyBUT0RPKGRlbXVyZ29zKTogQXZvaWQgY2FzdGluZ1xuICAgIHJldHVybiAoPGFueT4gdGhpcy50cnVzdGVkTWF0Y2hlcih2YWwpIGFzIEpzb25TZXJpYWxpemVyPFQ+KS53cml0ZUpzb24odmFsKTtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IFQpOiBFcnJvciB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgdHlwZTogVHlwZTxUPiB8IHVuZGVmaW5lZCA9IHRoaXMubWF0Y2hlcih2YWwpO1xuICAgIGlmICh0eXBlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBuZXcgSW5jaWRlbnQoXCJVbmtub3duVW5pb25WYXJpYW50XCIsIFwiVW5rbm93biB1bmlvbiB2YXJpYW50XCIpO1xuICAgIH1cbiAgICByZXR1cm4gdHlwZS50ZXN0RXJyb3IodmFsKTtcbiAgfVxuXG4gIHRlc3RXaXRoVmFyaWFudCh2YWw6IFQpOiBUZXN0V2l0aFZhcmlhbnRSZXN1bHQ8VD4ge1xuICAgIGNvbnN0IHZhcmlhbnQ6IFR5cGU8VD4gfCB1bmRlZmluZWQgPSB0aGlzLm1hdGNoZXIodmFsKTtcbiAgICBpZiAodmFyaWFudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gW2ZhbHNlIGFzIGZhbHNlLCB1bmRlZmluZWRdO1xuICAgIH1cbiAgICByZXR1cm4gW3ZhcmlhbnQudGVzdCh2YWwpLCB2YXJpYW50XSBhcyBUZXN0V2l0aFZhcmlhbnRSZXN1bHQ8VD47XG4gIH1cblxuICB0ZXN0KHZhbDogVCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHR5cGU6IFR5cGU8VD4gfCB1bmRlZmluZWQgPSB0aGlzLm1hdGNoZXIodmFsKTtcbiAgICBpZiAodHlwZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0eXBlLnRlc3QodmFsKTtcbiAgfVxuXG4gIC8vIFRPRE86IEFsd2F5cyByZXR1cm4gdHJ1ZT9cbiAgZXF1YWxzKHZhbDE6IFQsIHZhbDI6IFQpOiBib29sZWFuIHtcbiAgICBjb25zdCB0eXBlMTogVHlwZTxUPiA9IHRoaXMudHJ1c3RlZE1hdGNoZXIodmFsMSk7XG4gICAgY29uc3QgdHlwZTI6IFR5cGU8VD4gPSB0aGlzLnRydXN0ZWRNYXRjaGVyKHZhbDIpO1xuICAgIHJldHVybiB0eXBlMSA9PT0gdHlwZTIgJiYgdHlwZTEuZXF1YWxzKHZhbDEsIHZhbDIpO1xuICB9XG5cbiAgY2xvbmUodmFsOiBUKTogVCB7XG4gICAgcmV0dXJuIHRoaXMudHJ1c3RlZE1hdGNoZXIodmFsKS5jbG9uZSh2YWwpO1xuICB9XG5cbiAgZGlmZihvbGRWYWw6IFQsIG5ld1ZhbDogVCk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJVbmlvblR5cGUjZGlmZlwiKTtcbiAgfVxuXG4gIHBhdGNoKG9sZFZhbDogVCwgZGlmZjogRGlmZiB8IHVuZGVmaW5lZCk6IFQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJVbmlvblR5cGUjcGF0Y2hcIik7XG4gIH1cblxuICByZXZlcnNlRGlmZihkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIlVuaW9uVHlwZSNyZXZlcnNlRGlmZlwiKTtcbiAgfVxuXG4gIHNxdWFzaChkaWZmMTogRGlmZiB8IHVuZGVmaW5lZCwgZGlmZjI6IERpZmYgfCB1bmRlZmluZWQpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICB0aHJvdyBjcmVhdGVOb3RJbXBsZW1lbnRlZEVycm9yKFwiVW5pb25UeXBlI3NxdWFzaFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5T3B0aW9ucygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fb3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yKHRoaXMpO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zOiBVbmlvblR5cGVPcHRpb25zPFQsIGFueSwgYW55LCBhbnk+ID0gdHlwZW9mIHRoaXMuX29wdGlvbnMgPT09IFwiZnVuY3Rpb25cIlxuICAgICAgPyB0aGlzLl9vcHRpb25zKClcbiAgICAgIDogdGhpcy5fb3B0aW9ucztcbiAgICBkZWxldGUgdGhpcy5fb3B0aW9ucztcbiAgICBjb25zdCB2YXJpYW50czogVmVyc2lvbmVkVHlwZTxULCBhbnksIGFueSwgRGlmZj5bXSA9IG9wdGlvbnMudmFyaWFudHM7XG4gICAgY29uc3QgbWF0Y2hlcjogTWF0Y2hlcjxUPiA9IG9wdGlvbnMubWF0Y2hlcjtcblxuICAgIGxldCB0cnVzdGVkTWF0Y2hlcjogVHJ1c3RlZE1hdGNoZXI8VD47XG4gICAgaWYgKG9wdGlvbnMudHJ1c3RlZE1hdGNoZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdHJ1c3RlZE1hdGNoZXIgPSBvcHRpb25zLnRydXN0ZWRNYXRjaGVyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cnVzdGVkTWF0Y2hlciA9ICh2YWx1ZTogVCkgPT4ge1xuICAgICAgICBjb25zdCB2YXJpYW50OiBUeXBlPFQ+IHwgdW5kZWZpbmVkID0gbWF0Y2hlcih2YWx1ZSk7XG4gICAgICAgIGlmICh2YXJpYW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJVbmtub3duVW5pb25WYXJpYW50XCIsIFwiVW5rbm93biB1bmlvbiB2YXJpYW50XCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YXJpYW50O1xuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCByZWFkTWF0Y2hlcjogUmVhZE1hdGNoZXI8VD4gPSBvcHRpb25zLnJlYWRNYXRjaGVyO1xuXG4gICAgbGV0IHJlYWRUcnVzdGVkTWF0Y2hlcjogUmVhZFRydXN0ZWRNYXRjaGVyPFQ+O1xuICAgIGlmIChvcHRpb25zLnJlYWRUcnVzdGVkTWF0Y2hlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZWFkVHJ1c3RlZE1hdGNoZXIgPSBvcHRpb25zLnJlYWRUcnVzdGVkTWF0Y2hlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVhZFRydXN0ZWRNYXRjaGVyID0gKFxuICAgICAgICBpbnB1dDogYW55LFxuICAgICAgICBzZXJpYWxpemVyOiBTZXJpYWxpemVyLFxuICAgICAgKTogVHlwZTxUPiA9PiB7XG4gICAgICAgIGNvbnN0IHZhcmlhbnQ6IFR5cGU8VD4gfCB1bmRlZmluZWQgPSByZWFkTWF0Y2hlcihpbnB1dCwgc2VyaWFsaXplcik7XG4gICAgICAgIGlmICh2YXJpYW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJVbmtub3duVW5pb25WYXJpYW50XCIsIHtpbnB1dCwgc2VyaWFsaXplcn0sIFwiVW5rbm93biB1bmlvbiB2YXJpYW50XCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YXJpYW50O1xuICAgICAgfTtcbiAgICB9XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7dmFyaWFudHMsIG1hdGNoZXIsIHRydXN0ZWRNYXRjaGVyLCByZWFkTWF0Y2hlciwgcmVhZFRydXN0ZWRNYXRjaGVyfSk7XG4gICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLiJ9
