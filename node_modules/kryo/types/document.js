"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const lazy_properties_1 = require("../_helpers/lazy-properties");
const case_style_1 = require("../case-style");
const invalid_document_1 = require("../errors/invalid-document");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
const not_implemented_1 = require("../errors/not-implemented");
const json_1 = require("../json");
exports.name = "document";
// We use an `any` cast because of the `properties` property.
// tslint:disable-next-line:variable-name
exports.DocumentType = class {
    constructor(options) {
        this.name = exports.name;
        // TODO: Remove once TS 2.7 is better supported by editors
        this.ignoreExtraKeys = undefined;
        this.properties = undefined;
        this.keys = undefined;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["ignoreExtraKeys", "properties", "rename", "keys"]);
        }
    }
    static fromJSON(options) {
        throw not_implemented_1.createNotImplementedError("DocumentType.fromJSON");
    }
    toJSON() {
        throw not_implemented_1.createNotImplementedError("DocumentType#toJSON");
    }
    readTrustedJson(input) {
        const result = {}; // Object.create(null);
        for (const [key, outKey] of this.keys) {
            const descriptor = this.properties[key];
            const jsonValue = Reflect.get(input, outKey);
            if (jsonValue === undefined) {
                result[key] = undefined;
            }
            else {
                result[key] = json_1.JSON_SERIALIZER.readTrusted(descriptor.type, jsonValue);
            }
        }
        return result;
    }
    readJson(input) {
        const extra = this.ignoreExtraKeys ? undefined : new Set(Object.keys(input));
        const missing = new Set();
        const invalid = new Map();
        const result = {}; // Object.create(null);
        for (const [key, outKey] of this.keys) {
            if (extra !== undefined) {
                extra.delete(outKey);
            }
            const descriptor = this.properties[key];
            const jsonValue = Reflect.get(input, outKey);
            if (jsonValue === undefined) {
                if (descriptor.optional) {
                    result[key] = undefined;
                }
                else {
                    missing.add(key);
                }
                continue;
            }
            try {
                result[key] = json_1.JSON_SERIALIZER.read(descriptor.type, jsonValue);
            }
            catch (err) {
                invalid.set(key, err);
            }
        }
        if (extra !== undefined && extra.size > 0 || missing.size > 0 || invalid.size > 0) {
            throw invalid_document_1.createInvalidDocumentError({ extra, missing, invalid });
        }
        return result;
    }
    writeJson(val) {
        const result = {}; // Object.create(null);
        for (const [key, outKey] of this.keys) {
            const descriptor = this.properties[key];
            const value = val[key];
            if (value === undefined) {
                Reflect.set(result, outKey, undefined);
            }
            else {
                Reflect.set(result, outKey, json_1.JSON_SERIALIZER.write(descriptor.type, value));
            }
        }
        return result;
    }
    testError(val) {
        if (typeof val !== "object" || val === null) {
            return invalid_type_1.createInvalidTypeError("object", val);
        }
        const extra = this.ignoreExtraKeys ? undefined : new Set(Object.keys(val));
        const missing = new Set();
        const invalid = new Map();
        for (const key in this.properties) {
            if (extra !== undefined) {
                extra.delete(key);
            }
            const descriptor = this.properties[key];
            const propertyValue = val[key];
            if (propertyValue === undefined) {
                if (!descriptor.optional) {
                    missing.add(key);
                }
                continue;
            }
            const error = descriptor.type.testError(propertyValue);
            if (error !== undefined) {
                invalid.set(key, error);
            }
        }
        if (extra !== undefined && extra.size > 0 || missing.size > 0 || invalid.size > 0) {
            return invalid_document_1.createInvalidDocumentError({ extra, missing, invalid });
        }
        return undefined;
    }
    test(val) {
        if (typeof val !== "object" || val === null) {
            return false;
        }
        const extra = this.ignoreExtraKeys ? undefined : new Set(Object.keys(val));
        for (const key in this.properties) {
            if (extra !== undefined) {
                extra.delete(key);
            }
            const descriptor = this.properties[key];
            const propertyValue = val[key];
            if (propertyValue === undefined) {
                if (!descriptor.optional) {
                    return false;
                }
            }
            else if (!descriptor.type.test(propertyValue)) {
                return false;
            }
        }
        return extra === undefined || extra.size === 0;
    }
    equals(val1, val2) {
        for (const key in this.properties) {
            const descriptor = this.properties[key];
            if (!descriptor.optional) {
                if (!descriptor.type.equals(val1[key], val2[key])) {
                    return false;
                }
                continue;
            }
            if (val1[key] === undefined && val2[key] === undefined) {
                continue;
            }
            if (val1[key] === undefined || val2[key] === undefined || !descriptor.type.equals(val1[key], val2[key])) {
                return false;
            }
        }
        return true;
    }
    clone(val) {
        const result = {}; // Object.create(null);
        for (const key in this.properties) {
            result[key] = val[key] === undefined ? undefined : this.properties[key].type.clone(val[key]);
        }
        return result;
    }
    diff(oldVal, newVal) {
        let equal = true;
        const result = { set: {}, unset: {}, update: {} };
        for (const key in this.properties) {
            // TODO: Remove cast
            const descriptor = this.properties[key];
            const oldMember = oldVal[key];
            const newMember = newVal[key];
            if (oldMember !== undefined) {
                if (newMember !== undefined) {
                    const diff = descriptor.type.diff(oldMember, newMember);
                    if (diff !== undefined) {
                        result.update[key] = diff;
                        equal = false;
                    }
                }
                else {
                    result.unset[key] = descriptor.type.clone(oldMember);
                    equal = false;
                }
            }
            else {
                if (newMember === undefined) {
                    result.set[key] = descriptor.type.clone(newMember);
                    equal = false;
                }
            }
        }
        return equal ? undefined : result;
    }
    patch(oldVal, diff) {
        const result = this.clone(oldVal);
        if (diff === undefined) {
            return result;
        }
        for (const key in diff.set) {
            result[key] = this.properties[key].type.clone(diff.set[key]);
        }
        for (const key in diff.unset) {
            Reflect.deleteProperty(result, key);
        }
        for (const key in diff.update) {
            // TODO: Remove cast
            result[key] = this.properties[key].type.patch(result[key], diff.update[key]);
        }
        return result;
    }
    reverseDiff(diff) {
        if (diff === undefined) {
            return undefined;
        }
        const result = { set: {}, unset: {}, update: {} };
        for (const key in diff.unset) {
            result.set[key] = this.properties[key].type.clone(diff.unset[key]);
        }
        for (const key in diff.set) {
            result.unset[key] = this.properties[key].type.clone(diff.set[key]);
        }
        for (const key in diff.update) {
            // TODO: Remove cast
            result.update[key] = this.properties[key].type.reverseDiff(diff.update[key]);
        }
        return result;
    }
    squash(diff1, diff2) {
        throw not_implemented_1.createNotImplementedError("DocumentType#squash");
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ?
            this._options() :
            this._options;
        const ignoreExtraKeys = options.ignoreExtraKeys || false;
        const properties = options.properties;
        const renameAll = options.rename;
        const keys = renameKeys(properties, renameAll);
        Object.assign(this, { ignoreExtraKeys, properties, rename: renameAll, keys });
        Object.freeze(this);
    }
};
function renameKeys(obj, renameAll) {
    const keys = Object.keys(obj);
    const result = new Map();
    const outKeys = new Set();
    for (const key of keys) {
        const renamed = renameAll === undefined ? key : case_style_1.rename(key, renameAll);
        result.set(key, renamed);
        if (outKeys.has(renamed)) {
            throw new incident_1.Incident("NonBijectiveKeyRename", "Some keys are the same after renaming");
        }
        outKeys.add(renamed);
    }
    return result;
}
exports.renameKeys = renameKeys;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QVUsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFckUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBQyxlQUFlLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUM1RSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7Q0FDRixDQUFDO0FBRUYsb0JBQThCLEdBQU0sRUFBRSxTQUFxQjtJQUN6RCxNQUFNLElBQUksR0FBZ0IsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQWdCLENBQUM7SUFDMUQsTUFBTSxNQUFNLEdBQXlCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDL0MsTUFBTSxPQUFPLEdBQWdCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDdkMsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN2QixNQUFNLE9BQU8sR0FBVyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLG1CQUFNLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQy9FLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3pCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxtQkFBUSxDQUFDLHVCQUF1QixFQUFFLHVDQUF1QyxDQUFDLENBQUM7UUFDdkYsQ0FBQztRQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUNELE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQWJELGdDQWFDIiwiZmlsZSI6InR5cGVzL2RvY3VtZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5jaWRlbnQgfSBmcm9tIFwiaW5jaWRlbnRcIjtcbmltcG9ydCB7IGxhenlQcm9wZXJ0aWVzIH0gZnJvbSBcIi4uL19oZWxwZXJzL2xhenktcHJvcGVydGllc1wiO1xuaW1wb3J0IHsgQ2FzZVN0eWxlLCByZW5hbWUgfSBmcm9tIFwiLi4vY2FzZS1zdHlsZVwiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZERvY3VtZW50RXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtZG9jdW1lbnRcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtdHlwZVwiO1xuaW1wb3J0IHsgY3JlYXRlTGF6eU9wdGlvbnNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbGF6eS1vcHRpb25zXCI7XG5pbXBvcnQgeyBjcmVhdGVOb3RJbXBsZW1lbnRlZEVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9ub3QtaW1wbGVtZW50ZWRcIjtcbmltcG9ydCB7IEpTT05fU0VSSUFMSVpFUiB9IGZyb20gXCIuLi9qc29uXCI7XG5pbXBvcnQgeyBMYXp5LCBUeXBlIGFzIEtyeW9UeXBlLCBWZXJzaW9uZWRUeXBlIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcImRvY3VtZW50XCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwiZG9jdW1lbnRcIjtcbmV4cG9ydCBuYW1lc3BhY2UganNvbiB7XG4gIGV4cG9ydCBpbnRlcmZhY2UgVHlwZSB7XG4gICAgbmFtZTogTmFtZTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIERpZmY8VD4ge1xuICBzZXQ6IHtbUCBpbiBrZXlvZiBUXT86IGFueX07IC8vIHZhbFxuICB1cGRhdGU6IHtbUCBpbiBrZXlvZiBUXT86IGFueX07IC8vIGRpZmZcbiAgdW5zZXQ6IHtbUCBpbiBrZXlvZiBUXT86IGFueX07IC8vIHZhbFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIERvY3VtZW50VHlwZU9wdGlvbnM8VD4ge1xuICAvKipcbiAgICogRG8gbm90IHRocm93IGVycm9yIHdoZW4gdGhlIG9iamVjdCBjb250YWlucyBleHRyYW5lb3VzIGtleXMuXG4gICAqL1xuICBpZ25vcmVFeHRyYUtleXM/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBBIGRpY3Rpb25hcnkgYmV0d2VlbiBhIHByb3BlcnR5IG5hbWUgYW5kIGl0cyBkZXNjcmlwdGlvbi5cbiAgICovXG4gIHByb3BlcnRpZXM6IHtbUCBpbiBrZXlvZiBUXTogUHJvcGVydHlEZXNjcmlwdG9yPEtyeW9UeXBlPFRbUF0+Pn07XG5cbiAgLyoqXG4gICAqIFRoZSBrZXlzIG9mIHRoZSBzZXJpYWxpemVkIGRvY3VtZW50cyBhcmUgcmVuYW1lZCBmb2xsb3dpbmcgdGhlXG4gICAqIHN1cHBsaWVkIHN0eWxlICh1bmRlZmluZWQgdG8ga2VlcCB0aGUgb3JpZ2luYWwgbmFtZSkuXG4gICAqL1xuICByZW5hbWU/OiBDYXNlU3R5bGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvcGVydHlEZXNjcmlwdG9yPE1ldGFUeXBlIGV4dGVuZHMgS3J5b1R5cGU8YW55Pj4ge1xuICAvKipcbiAgICogQWxsb3dzIHRoaXMgcHJvcGVydHkgdG8gYmUgbWlzc2luZyAodW5kZWZpbmVkIHZhbHVlcyB0aHJvdyBlcnJvcnMpLlxuICAgKi9cbiAgb3B0aW9uYWw/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5LlxuICAgKi9cbiAgdHlwZTogTWV0YVR5cGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRG9jdW1lbnRUeXBlQ29uc3RydWN0b3Ige1xuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGRvY3VtZW50IHR5cGUgY2hlY2tpbmcgZm9yIG9iamVjdHMgd2l0aCB0aGUgc3VwcGxpZWQgcHJvcGVydGllcy5cbiAgICpcbiAgICogVGhlIGdlbmVyaWMgdHlwZSBgVGAgaXMgdGhlIGludGVyZmFjZSBkZXNjcmliZWQgYnkgdGhpcyBpbnN0YW5jZS5cbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMgT3B0aW9ucyBkZXNjcmliaW5nIHRoaXMgZG9jdW1lbnQgdHlwZS5cbiAgICogQHJldHVybiBUaGUgZG9jdW1lbnQgdHlwZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm92aWRlZCBvcHRpb25zXG4gICAqL1xuICBuZXc8VD4ob3B0aW9uczogTGF6eTxEb2N1bWVudFR5cGVPcHRpb25zPFQ+Pik6IERvY3VtZW50VHlwZTxUPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEb2N1bWVudFR5cGU8VD4gZXh0ZW5kcyBWZXJzaW9uZWRUeXBlPFQsIGFueSwgYW55LCBEaWZmPFQ+PiwgRG9jdW1lbnRUeXBlT3B0aW9uczxUPiB7XG59XG5cbi8vIFdlIHVzZSBhbiBgYW55YCBjYXN0IGJlY2F1c2Ugb2YgdGhlIGBwcm9wZXJ0aWVzYCBwcm9wZXJ0eS5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp2YXJpYWJsZS1uYW1lXG5leHBvcnQgY29uc3QgRG9jdW1lbnRUeXBlOiBEb2N1bWVudFR5cGVDb25zdHJ1Y3RvciA9IGNsYXNzPFQgZXh0ZW5kcyB7fT4ge1xuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgaWdub3JlRXh0cmFLZXlzOiBib29sZWFuO1xuICByZWFkb25seSBwcm9wZXJ0aWVzOiB7W1AgaW4ga2V5b2YgVF06IFByb3BlcnR5RGVzY3JpcHRvcjxLcnlvVHlwZTxUW1BdPj59O1xuICByZWFkb25seSByZW5hbWU/OiBDYXNlU3R5bGU7XG5cbiAgLyoqXG4gICAqIE1hcCBmcm9tIHRoZSBkb2N1bWVudCBrZXlzIHRvIHRoZSBzZXJpYWxpemVkIG5hbWVzXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGtleXM6IE1hcDxrZXlvZiBULCBzdHJpbmc+O1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IExhenk8RG9jdW1lbnRUeXBlT3B0aW9uczxUPj47XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogTGF6eTxEb2N1bWVudFR5cGVPcHRpb25zPFQ+Pikge1xuICAgIC8vIFRPRE86IFJlbW92ZSBvbmNlIFRTIDIuNyBpcyBiZXR0ZXIgc3VwcG9ydGVkIGJ5IGVkaXRvcnNcbiAgICB0aGlzLmlnbm9yZUV4dHJhS2V5cyA9IDxhbnk+IHVuZGVmaW5lZDtcbiAgICB0aGlzLnByb3BlcnRpZXMgPSA8YW55PiB1bmRlZmluZWQ7XG4gICAgdGhpcy5rZXlzID0gPGFueT4gdW5kZWZpbmVkO1xuXG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXp5UHJvcGVydGllcyh0aGlzLCB0aGlzLl9hcHBseU9wdGlvbnMsIFtcImlnbm9yZUV4dHJhS2V5c1wiLCBcInByb3BlcnRpZXNcIiwgXCJyZW5hbWVcIiwgXCJrZXlzXCIgYXMga2V5b2YgdGhpc10pO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBmcm9tSlNPTihvcHRpb25zOiBqc29uLlR5cGUpOiBEb2N1bWVudFR5cGU8e30+IHtcbiAgICB0aHJvdyBjcmVhdGVOb3RJbXBsZW1lbnRlZEVycm9yKFwiRG9jdW1lbnRUeXBlLmZyb21KU09OXCIpO1xuICB9XG5cbiAgdG9KU09OKCk6IGpzb24uVHlwZSB7XG4gICAgdGhyb3cgY3JlYXRlTm90SW1wbGVtZW50ZWRFcnJvcihcIkRvY3VtZW50VHlwZSN0b0pTT05cIik7XG4gIH1cblxuICByZWFkVHJ1c3RlZEpzb24oaW5wdXQ6IGFueSk6IFQge1xuICAgIGNvbnN0IHJlc3VsdDogUGFydGlhbDxUPiA9IHt9OyAvLyBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIGZvciAoY29uc3QgW2tleSwgb3V0S2V5XSBvZiB0aGlzLmtleXMpIHtcbiAgICAgIGNvbnN0IGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+ID0gdGhpcy5wcm9wZXJ0aWVzW2tleV07XG4gICAgICBjb25zdCBqc29uVmFsdWU6IGFueSA9IFJlZmxlY3QuZ2V0KGlucHV0LCBvdXRLZXkpO1xuICAgICAgaWYgKGpzb25WYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gdW5kZWZpbmVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSBKU09OX1NFUklBTElaRVIucmVhZFRydXN0ZWQoZGVzY3JpcHRvci50eXBlLCBqc29uVmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0IGFzIFQ7XG4gIH1cblxuICByZWFkSnNvbihpbnB1dDogYW55KTogVCB7XG4gICAgY29uc3QgZXh0cmE6IFNldDxzdHJpbmc+IHwgdW5kZWZpbmVkID0gdGhpcy5pZ25vcmVFeHRyYUtleXMgPyB1bmRlZmluZWQgOiBuZXcgU2V0KE9iamVjdC5rZXlzKGlucHV0KSk7XG4gICAgY29uc3QgbWlzc2luZzogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gICAgY29uc3QgaW52YWxpZDogTWFwPGtleW9mIFQsIEVycm9yPiA9IG5ldyBNYXAoKTtcblxuICAgIGNvbnN0IHJlc3VsdDogUGFydGlhbDxUPiA9IHt9OyAvLyBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCBvdXRLZXldIG9mIHRoaXMua2V5cykge1xuICAgICAgaWYgKGV4dHJhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZXh0cmEuZGVsZXRlKG91dEtleSk7XG4gICAgICB9XG4gICAgICBjb25zdCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3I8YW55PiA9IHRoaXMucHJvcGVydGllc1trZXldO1xuICAgICAgY29uc3QganNvblZhbHVlOiBhbnkgPSBSZWZsZWN0LmdldChpbnB1dCwgb3V0S2V5KTtcbiAgICAgIGlmIChqc29uVmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoZGVzY3JpcHRvci5vcHRpb25hbCkge1xuICAgICAgICAgIHJlc3VsdFtrZXldID0gdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG1pc3NpbmcuYWRkKGtleSk7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICByZXN1bHRba2V5XSA9IEpTT05fU0VSSUFMSVpFUi5yZWFkKGRlc2NyaXB0b3IudHlwZSwganNvblZhbHVlKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpbnZhbGlkLnNldChrZXksIGVycik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGV4dHJhICE9PSB1bmRlZmluZWQgJiYgZXh0cmEuc2l6ZSA+IDAgfHwgbWlzc2luZy5zaXplID4gMCB8fCBpbnZhbGlkLnNpemUgPiAwKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkRG9jdW1lbnRFcnJvcih7ZXh0cmEsIG1pc3NpbmcsIGludmFsaWR9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdCBhcyBUO1xuICB9XG5cbiAgd3JpdGVKc29uKHZhbDogVCk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7fTsgLy8gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIG91dEtleV0gb2YgdGhpcy5rZXlzKSB7XG4gICAgICBjb25zdCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3I8VFtrZXlvZiBUXT4gPSB0aGlzLnByb3BlcnRpZXNba2V5XTtcbiAgICAgIGNvbnN0IHZhbHVlOiBUW2tleW9mIFRdID0gdmFsW2tleV07XG4gICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBSZWZsZWN0LnNldChyZXN1bHQsIG91dEtleSwgdW5kZWZpbmVkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIFJlZmxlY3Quc2V0KHJlc3VsdCwgb3V0S2V5LCBKU09OX1NFUklBTElaRVIud3JpdGUoZGVzY3JpcHRvci50eXBlLCB2YWx1ZSkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0IGFzIFQ7XG4gIH1cblxuICB0ZXN0RXJyb3IodmFsOiBUKTogRXJyb3IgfCB1bmRlZmluZWQge1xuICAgIGlmICh0eXBlb2YgdmFsICE9PSBcIm9iamVjdFwiIHx8IHZhbCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJvYmplY3RcIiwgdmFsKTtcbiAgICB9XG5cbiAgICBjb25zdCBleHRyYTogU2V0PHN0cmluZz4gfCB1bmRlZmluZWQgPSB0aGlzLmlnbm9yZUV4dHJhS2V5cyA/IHVuZGVmaW5lZCA6IG5ldyBTZXQoT2JqZWN0LmtleXModmFsKSk7XG4gICAgY29uc3QgbWlzc2luZzogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gICAgY29uc3QgaW52YWxpZDogTWFwPGtleW9mIFQsIEVycm9yPiA9IG5ldyBNYXAoKTtcblxuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMucHJvcGVydGllcykge1xuICAgICAgaWYgKGV4dHJhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZXh0cmEuZGVsZXRlKGtleSk7XG4gICAgICB9XG4gICAgICBjb25zdCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3I8YW55PiA9IHRoaXMucHJvcGVydGllc1trZXldO1xuICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZTogYW55ID0gdmFsW2tleV07XG4gICAgICBpZiAocHJvcGVydHlWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmICghZGVzY3JpcHRvci5vcHRpb25hbCkge1xuICAgICAgICAgIG1pc3NpbmcuYWRkKGtleSk7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBlcnJvcjogRXJyb3IgfCB1bmRlZmluZWQgPSBkZXNjcmlwdG9yLnR5cGUudGVzdEVycm9yKHByb3BlcnR5VmFsdWUpO1xuICAgICAgaWYgKGVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaW52YWxpZC5zZXQoa2V5LCBlcnJvcik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGV4dHJhICE9PSB1bmRlZmluZWQgJiYgZXh0cmEuc2l6ZSA+IDAgfHwgbWlzc2luZy5zaXplID4gMCB8fCBpbnZhbGlkLnNpemUgPiAwKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZERvY3VtZW50RXJyb3Ioe2V4dHJhLCBtaXNzaW5nLCBpbnZhbGlkfSk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogVCk6IHZhbCBpcyBUIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJvYmplY3RcIiB8fCB2YWwgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBleHRyYTogU2V0PHN0cmluZz4gfCB1bmRlZmluZWQgPSB0aGlzLmlnbm9yZUV4dHJhS2V5cyA/IHVuZGVmaW5lZCA6IG5ldyBTZXQoT2JqZWN0LmtleXModmFsKSk7XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIGlmIChleHRyYSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGV4dHJhLmRlbGV0ZShrZXkpO1xuICAgICAgfVxuICAgICAgY29uc3QgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB0aGlzLnByb3BlcnRpZXNba2V5XTtcbiAgICAgIGNvbnN0IHByb3BlcnR5VmFsdWU6IGFueSA9IHZhbFtrZXldO1xuICAgICAgaWYgKHByb3BlcnR5VmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoIWRlc2NyaXB0b3Iub3B0aW9uYWwpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoIWRlc2NyaXB0b3IudHlwZS50ZXN0KHByb3BlcnR5VmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZXh0cmEgPT09IHVuZGVmaW5lZCB8fCBleHRyYS5zaXplID09PSAwO1xuICB9XG5cbiAgZXF1YWxzKHZhbDE6IFQsIHZhbDI6IFQpOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIGNvbnN0IGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcjxLcnlvVHlwZTxhbnk+PiA9IHRoaXMucHJvcGVydGllc1trZXldO1xuICAgICAgaWYgKCFkZXNjcmlwdG9yLm9wdGlvbmFsKSB7XG4gICAgICAgIGlmICghZGVzY3JpcHRvci50eXBlLmVxdWFscyh2YWwxW2tleV0sIHZhbDJba2V5XSkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAodmFsMVtrZXldID09PSB1bmRlZmluZWQgJiYgdmFsMltrZXldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAodmFsMVtrZXldID09PSB1bmRlZmluZWQgfHwgdmFsMltrZXldID09PSB1bmRlZmluZWQgfHwgIWRlc2NyaXB0b3IudHlwZS5lcXVhbHModmFsMVtrZXldLCB2YWwyW2tleV0pKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBjbG9uZSh2YWw6IFQpOiBUIHtcbiAgICBjb25zdCByZXN1bHQ6IFBhcnRpYWw8VD4gPSB7fTsgLy8gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIHJlc3VsdFtrZXldID0gdmFsW2tleV0gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHRoaXMucHJvcGVydGllc1trZXldLnR5cGUuY2xvbmUodmFsW2tleV0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0IGFzIFQ7XG4gIH1cblxuICBkaWZmKG9sZFZhbDogVCwgbmV3VmFsOiBUKTogRGlmZjxUPiB8IHVuZGVmaW5lZCB7XG4gICAgbGV0IGVxdWFsOiBib29sZWFuID0gdHJ1ZTtcbiAgICBjb25zdCByZXN1bHQ6IERpZmY8VD4gPSB7c2V0OiB7fSwgdW5zZXQ6IHt9LCB1cGRhdGU6IHt9fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIC8vIFRPRE86IFJlbW92ZSBjYXN0XG4gICAgICBjb25zdCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3I8VmVyc2lvbmVkVHlwZTxhbnksIGFueSwgYW55LCBhbnk+PiA9IDxhbnk+IHRoaXMucHJvcGVydGllc1trZXldO1xuICAgICAgY29uc3Qgb2xkTWVtYmVyOiBhbnkgPSAoPGFueT4gb2xkVmFsKVtrZXldO1xuICAgICAgY29uc3QgbmV3TWVtYmVyOiBhbnkgPSAoPGFueT4gbmV3VmFsKVtrZXldO1xuICAgICAgaWYgKG9sZE1lbWJlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmIChuZXdNZW1iZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbnN0IGRpZmY6IGFueSA9IGRlc2NyaXB0b3IudHlwZS5kaWZmKG9sZE1lbWJlciwgbmV3TWVtYmVyKTtcbiAgICAgICAgICBpZiAoZGlmZiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXN1bHQudXBkYXRlW2tleV0gPSBkaWZmO1xuICAgICAgICAgICAgZXF1YWwgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0LnVuc2V0W2tleV0gPSBkZXNjcmlwdG9yLnR5cGUuY2xvbmUob2xkTWVtYmVyKTtcbiAgICAgICAgICBlcXVhbCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobmV3TWVtYmVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXN1bHQuc2V0W2tleV0gPSBkZXNjcmlwdG9yLnR5cGUuY2xvbmUobmV3TWVtYmVyKTtcbiAgICAgICAgICBlcXVhbCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBlcXVhbCA/IHVuZGVmaW5lZCA6IHJlc3VsdDtcbiAgfVxuXG4gIHBhdGNoKG9sZFZhbDogVCwgZGlmZjogRGlmZjxUPiB8IHVuZGVmaW5lZCk6IFQge1xuICAgIGNvbnN0IHJlc3VsdDogVCA9IHRoaXMuY2xvbmUob2xkVmFsKTtcbiAgICBpZiAoZGlmZiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBkaWZmLnNldCkge1xuICAgICAgcmVzdWx0W2tleV0gPSB0aGlzLnByb3BlcnRpZXNba2V5XS50eXBlLmNsb25lKGRpZmYuc2V0W2tleV0pO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBkaWZmLnVuc2V0KSB7XG4gICAgICBSZWZsZWN0LmRlbGV0ZVByb3BlcnR5KHJlc3VsdCwga2V5KTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZGlmZi51cGRhdGUpIHtcbiAgICAgIC8vIFRPRE86IFJlbW92ZSBjYXN0XG4gICAgICByZXN1bHRba2V5XSA9ICh0aGlzLnByb3BlcnRpZXNba2V5XS50eXBlIGFzIGFueSkucGF0Y2gocmVzdWx0W2tleV0sIGRpZmYudXBkYXRlW2tleV0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcmV2ZXJzZURpZmYoZGlmZjogRGlmZjxUPiB8IHVuZGVmaW5lZCk6IERpZmY8VD4gfCB1bmRlZmluZWQge1xuICAgIGlmIChkaWZmID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdDogRGlmZjxUPiA9IHtzZXQ6IHt9LCB1bnNldDoge30sIHVwZGF0ZToge319O1xuICAgIGZvciAoY29uc3Qga2V5IGluIGRpZmYudW5zZXQpIHtcbiAgICAgIHJlc3VsdC5zZXRba2V5XSA9IHRoaXMucHJvcGVydGllc1trZXldLnR5cGUuY2xvbmUoZGlmZi51bnNldFtrZXldKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZGlmZi5zZXQpIHtcbiAgICAgIHJlc3VsdC51bnNldFtrZXldID0gdGhpcy5wcm9wZXJ0aWVzW2tleV0udHlwZS5jbG9uZShkaWZmLnNldFtrZXldKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZGlmZi51cGRhdGUpIHtcbiAgICAgIC8vIFRPRE86IFJlbW92ZSBjYXN0XG4gICAgICByZXN1bHQudXBkYXRlW2tleV0gPSAodGhpcy5wcm9wZXJ0aWVzW2tleV0udHlwZSBhcyBhbnkpLnJldmVyc2VEaWZmKGRpZmYudXBkYXRlW2tleV0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3F1YXNoKGRpZmYxOiBEaWZmPFQ+IHwgdW5kZWZpbmVkLCBkaWZmMjogRGlmZjxUPiB8IHVuZGVmaW5lZCk6IERpZmY8VD4gfCB1bmRlZmluZWQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJEb2N1bWVudFR5cGUjc3F1YXNoXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlPcHRpb25zKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9vcHRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IodGhpcyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnM6IERvY3VtZW50VHlwZU9wdGlvbnM8VD4gPSB0eXBlb2YgdGhpcy5fb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiID9cbiAgICAgIHRoaXMuX29wdGlvbnMoKSA6XG4gICAgICB0aGlzLl9vcHRpb25zO1xuXG4gICAgY29uc3QgaWdub3JlRXh0cmFLZXlzOiBib29sZWFuID0gb3B0aW9ucy5pZ25vcmVFeHRyYUtleXMgfHwgZmFsc2U7XG4gICAgY29uc3QgcHJvcGVydGllczoge1tQIGluIGtleW9mIFRdOiBQcm9wZXJ0eURlc2NyaXB0b3I8S3J5b1R5cGU8YW55Pj59ID0gb3B0aW9ucy5wcm9wZXJ0aWVzO1xuICAgIGNvbnN0IHJlbmFtZUFsbDogQ2FzZVN0eWxlIHwgdW5kZWZpbmVkID0gb3B0aW9ucy5yZW5hbWU7XG4gICAgY29uc3Qga2V5czogTWFwPGtleW9mIFQsIHN0cmluZz4gPSByZW5hbWVLZXlzKHByb3BlcnRpZXMsIHJlbmFtZUFsbCk7XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtpZ25vcmVFeHRyYUtleXMsIHByb3BlcnRpZXMsIHJlbmFtZTogcmVuYW1lQWxsLCBrZXlzfSk7XG4gICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgfVxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmFtZUtleXM8VD4ob2JqOiBULCByZW5hbWVBbGw/OiBDYXNlU3R5bGUpOiBNYXA8a2V5b2YgVCwgc3RyaW5nPiB7XG4gIGNvbnN0IGtleXM6IChrZXlvZiBUKVtdID0gT2JqZWN0LmtleXMob2JqKSBhcyAoa2V5b2YgVClbXTtcbiAgY29uc3QgcmVzdWx0OiBNYXA8a2V5b2YgVCwgc3RyaW5nPiA9IG5ldyBNYXAoKTtcbiAgY29uc3Qgb3V0S2V5czogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICBjb25zdCByZW5hbWVkOiBzdHJpbmcgPSByZW5hbWVBbGwgPT09IHVuZGVmaW5lZCA/IGtleSA6IHJlbmFtZShrZXksIHJlbmFtZUFsbCk7XG4gICAgcmVzdWx0LnNldChrZXksIHJlbmFtZWQpO1xuICAgIGlmIChvdXRLZXlzLmhhcyhyZW5hbWVkKSkge1xuICAgICAgdGhyb3cgbmV3IEluY2lkZW50KFwiTm9uQmlqZWN0aXZlS2V5UmVuYW1lXCIsIFwiU29tZSBrZXlzIGFyZSB0aGUgc2FtZSBhZnRlciByZW5hbWluZ1wiKTtcbiAgICB9XG4gICAgb3V0S2V5cy5hZGQocmVuYW1lZCk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdLCJzb3VyY2VSb290IjoiLi4ifQ==
