"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
/**
 * Checked version of `punycode.ucs2.decode`, throws an error if
 * there is an unmatched surrogate half.
 *
 * @see <https://github.com/bestiejs/punycode.js/issues/67>
 * @name decode
 * @param string The Unicode input string (UCS-2).
 * @param check Throw an error if there is an unmatched surrogate half.
 * @returns The new array of code points.
 */
function checkedUcs2Decode(string, check = true) {
    const output = [];
    let counter = 0;
    const length = string.length;
    while (counter < length) {
        const value = string.charCodeAt(counter++);
        if (value >= 0xD800 && value <= 0xDBFF && counter < length) {
            // It's a high surrogate, and there is a next character.
            const extra = string.charCodeAt(counter++);
            if ((extra & 0xFC00) === 0xDC00) {
                output.push(((value & 0x3FF) << 10) + (extra & 0x3FF) + 0x10000);
            }
            else if (check) {
                throw new incident_1.Incident("InvalidUcs2String", `Unmatched high surrogate half at index ${counter - 2}`);
            }
            else {
                // It's an unmatched surrogate; only append this code unit, in case the
                // next code unit is the high surrogate of a surrogate pair.
                output.push(value);
                counter--;
            }
        }
        else if (value >= 0xD800 && value <= 0xDBFF && counter === length) {
            throw new incident_1.Incident("InvalidUcs2String", `Unmatched high surrogate half at index ${counter - 1}`);
        }
        else if ((value & 0xFC00) === 0xDC00) {
            // Low surrogate that wasn't matched by a preceding high surrogate.
            throw new incident_1.Incident("InvalidUcs2String", `Unmatched low surrogate half at index ${counter - 1}`);
        }
        else {
            output.push(value);
        }
    }
    return output;
}
exports.checkedUcs2Decode = checkedUcs2Decode;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIl9oZWxwZXJzL2NoZWNrZWQtdWNzMi1kZWNvZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBb0M7QUFFcEM7Ozs7Ozs7OztHQVNHO0FBQ0gsMkJBQWtDLE1BQWMsRUFBRSxRQUFpQixJQUFJO0lBQ3JFLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztJQUM1QixJQUFJLE9BQU8sR0FBVyxDQUFDLENBQUM7SUFDeEIsTUFBTSxNQUFNLEdBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNyQyxPQUFPLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQztRQUN4QixNQUFNLEtBQUssR0FBVyxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDbkQsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLE1BQU0sSUFBSSxLQUFLLElBQUksTUFBTSxJQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzNELHdEQUF3RDtZQUN4RCxNQUFNLEtBQUssR0FBVyxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDbkQsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDO1lBQ25FLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDakIsTUFBTSxJQUFJLG1CQUFRLENBQUMsbUJBQW1CLEVBQUUsMENBQTBDLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ25HLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTix1RUFBdUU7Z0JBQ3ZFLDREQUE0RDtnQkFDNUQsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkIsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDO1FBQ0gsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksTUFBTSxJQUFJLEtBQUssSUFBSSxNQUFNLElBQUksT0FBTyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDcEUsTUFBTSxJQUFJLG1CQUFRLENBQUMsbUJBQW1CLEVBQUUsMENBQTBDLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25HLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN2QyxtRUFBbUU7WUFDbkUsTUFBTSxJQUFJLG1CQUFRLENBQUMsbUJBQW1CLEVBQUUseUNBQXlDLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xHLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUM7SUFDRCxNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUE3QkQsOENBNkJDIiwiZmlsZSI6Il9oZWxwZXJzL2NoZWNrZWQtdWNzMi1kZWNvZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuXG4vKipcbiAqIENoZWNrZWQgdmVyc2lvbiBvZiBgcHVueWNvZGUudWNzMi5kZWNvZGVgLCB0aHJvd3MgYW4gZXJyb3IgaWZcbiAqIHRoZXJlIGlzIGFuIHVubWF0Y2hlZCBzdXJyb2dhdGUgaGFsZi5cbiAqXG4gKiBAc2VlIDxodHRwczovL2dpdGh1Yi5jb20vYmVzdGllanMvcHVueWNvZGUuanMvaXNzdWVzLzY3PlxuICogQG5hbWUgZGVjb2RlXG4gKiBAcGFyYW0gc3RyaW5nIFRoZSBVbmljb2RlIGlucHV0IHN0cmluZyAoVUNTLTIpLlxuICogQHBhcmFtIGNoZWNrIFRocm93IGFuIGVycm9yIGlmIHRoZXJlIGlzIGFuIHVubWF0Y2hlZCBzdXJyb2dhdGUgaGFsZi5cbiAqIEByZXR1cm5zIFRoZSBuZXcgYXJyYXkgb2YgY29kZSBwb2ludHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjaGVja2VkVWNzMkRlY29kZShzdHJpbmc6IHN0cmluZywgY2hlY2s6IGJvb2xlYW4gPSB0cnVlKTogbnVtYmVyW10ge1xuICBjb25zdCBvdXRwdXQ6IG51bWJlcltdID0gW107XG4gIGxldCBjb3VudGVyOiBudW1iZXIgPSAwO1xuICBjb25zdCBsZW5ndGg6IG51bWJlciA9IHN0cmluZy5sZW5ndGg7XG4gIHdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7XG4gICAgY29uc3QgdmFsdWU6IG51bWJlciA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7XG4gICAgaWYgKHZhbHVlID49IDB4RDgwMCAmJiB2YWx1ZSA8PSAweERCRkYgJiYgY291bnRlciA8IGxlbmd0aCkge1xuICAgICAgLy8gSXQncyBhIGhpZ2ggc3Vycm9nYXRlLCBhbmQgdGhlcmUgaXMgYSBuZXh0IGNoYXJhY3Rlci5cbiAgICAgIGNvbnN0IGV4dHJhOiBudW1iZXIgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspO1xuICAgICAgaWYgKChleHRyYSAmIDB4RkMwMCkgPT09IDB4REMwMCkgeyAvLyBMb3cgc3Vycm9nYXRlLlxuICAgICAgICBvdXRwdXQucHVzaCgoKHZhbHVlICYgMHgzRkYpIDw8IDEwKSArIChleHRyYSAmIDB4M0ZGKSArIDB4MTAwMDApO1xuICAgICAgfSBlbHNlIGlmIChjaGVjaykge1xuICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJJbnZhbGlkVWNzMlN0cmluZ1wiLCBgVW5tYXRjaGVkIGhpZ2ggc3Vycm9nYXRlIGhhbGYgYXQgaW5kZXggJHtjb3VudGVyIC0gMn1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIEl0J3MgYW4gdW5tYXRjaGVkIHN1cnJvZ2F0ZTsgb25seSBhcHBlbmQgdGhpcyBjb2RlIHVuaXQsIGluIGNhc2UgdGhlXG4gICAgICAgIC8vIG5leHQgY29kZSB1bml0IGlzIHRoZSBoaWdoIHN1cnJvZ2F0ZSBvZiBhIHN1cnJvZ2F0ZSBwYWlyLlxuICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7XG4gICAgICAgIGNvdW50ZXItLTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHZhbHVlID49IDB4RDgwMCAmJiB2YWx1ZSA8PSAweERCRkYgJiYgY291bnRlciA9PT0gbGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJJbnZhbGlkVWNzMlN0cmluZ1wiLCBgVW5tYXRjaGVkIGhpZ2ggc3Vycm9nYXRlIGhhbGYgYXQgaW5kZXggJHtjb3VudGVyIC0gMX1gKTtcbiAgICB9IGVsc2UgaWYgKCh2YWx1ZSAmIDB4RkMwMCkgPT09IDB4REMwMCkge1xuICAgICAgLy8gTG93IHN1cnJvZ2F0ZSB0aGF0IHdhc24ndCBtYXRjaGVkIGJ5IGEgcHJlY2VkaW5nIGhpZ2ggc3Vycm9nYXRlLlxuICAgICAgdGhyb3cgbmV3IEluY2lkZW50KFwiSW52YWxpZFVjczJTdHJpbmdcIiwgYFVubWF0Y2hlZCBsb3cgc3Vycm9nYXRlIGhhbGYgYXQgaW5kZXggJHtjb3VudGVyIC0gMX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgb3V0cHV0LnB1c2godmFsdWUpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gb3V0cHV0O1xufVxuIl0sInNvdXJjZVJvb3QiOiIuLiJ9
